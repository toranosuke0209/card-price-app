<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
    <link rel="icon" type="image/png" sizes="32x32" href="/static/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/static/favicon-16x16.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="canonical" href="https://bsprice.net/card/">
    <!-- Google Analytics (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-5WL1F00NNC"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-5WL1F00NNC');
    </script>
    <meta name="description" content="バトルスピリッツのカード価格を複数ショップで比較">
    <title>カード詳細 | BSPrice - バトスピ価格比較</title>
    <!-- OGP -->
    <meta property="og:title" content="カード詳細 | BSPrice - バトスピ価格比較">
    <meta property="og:description" content="バトルスピリッツのカード価格を複数ショップで比較">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://bsprice.net/card/">
    <meta property="og:site_name" content="BSPrice">
    <meta property="og:locale" content="ja_JP">
    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="カード詳細 | BSPrice - バトスピ価格比較">
    <meta name="twitter:description" content="バトルスピリッツのカード価格を複数ショップで比較">
    <!-- 構造化データ (JSON-LD) - パンくずリスト -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "BreadcrumbList",
        "itemListElement": [
            {
                "@type": "ListItem",
                "position": 1,
                "name": "トップ",
                "item": "https://bsprice.net/"
            },
            {
                "@type": "ListItem",
                "position": 2,
                "name": "カード詳細"
            }
        ]
    }
    </script>
    <link rel="stylesheet" href="/static/style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2167017279500518"
         crossorigin="anonymous"></script>
    <style>
        .card-detail {
            background: var(--card-background);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
        }
        .card-header {
            display: flex;
            gap: 24px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }
        .card-image {
            flex-shrink: 0;
        }
        .card-image img {
            width: 200px;
            height: auto;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        .card-info {
            flex: 1;
            min-width: 250px;
        }
        .card-name {
            font-size: 1.8rem;
            font-weight: bold;
            color: var(--text-primary);
            margin-bottom: 16px;
        }
        .card-stats {
            display: flex;
            gap: 24px;
            flex-wrap: wrap;
            margin-bottom: 16px;
        }
        .stat-item {
            text-align: center;
        }
        .stat-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }
        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--accent-color);
        }
        .external-links {
            margin-top: 16px;
        }
        .external-link {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            background: var(--button-secondary-bg);
            color: var(--text-primary);
            border-radius: 6px;
            text-decoration: none;
            font-size: 0.9rem;
            transition: background 0.2s;
        }
        .external-link:hover {
            background: var(--button-secondary-hover);
        }
        .price-table {
            width: 100%;
            border-collapse: collapse;
        }
        .price-table th,
        .price-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }
        .price-table th {
            background: var(--background-secondary);
            font-weight: 600;
            color: var(--text-secondary);
        }
        .price-table tr:hover {
            background: var(--background-secondary);
        }
        .price-value {
            font-weight: bold;
            color: var(--accent-color);
            font-size: 1.1rem;
        }
        .price-lowest {
            color: #4ade80;
        }
        .stock-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.85rem;
        }
        .stock-available {
            background: rgba(74, 222, 128, 0.2);
            color: #4ade80;
        }
        .stock-soldout {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }
        .shop-link {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 10px 20px;
            background: linear-gradient(135deg, #f97316, #ea580c);
            color: white;
            border-radius: 6px;
            text-decoration: none;
            font-size: 0.9rem;
            font-weight: bold;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 2px 8px rgba(249, 115, 22, 0.3);
            white-space: nowrap;
        }
        .shop-link:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(249, 115, 22, 0.4);
        }
        .section-title {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--text-primary);
            margin-bottom: 16px;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--accent-color);
        }
        .breadcrumb {
            margin-bottom: 16px;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }
        .breadcrumb a {
            color: var(--accent-color);
            text-decoration: none;
        }
        .breadcrumb a:hover {
            text-decoration: underline;
        }
        .card-number {
            display: inline-block;
            background: var(--accent-color);
            color: white;
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 0.9rem;
            font-weight: bold;
            margin-bottom: 12px;
        }
        .related-cards-section {
            margin-top: 32px;
        }
        .related-cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 16px;
        }
        .related-card {
            background: var(--background-secondary);
            border-radius: 8px;
            padding: 16px;
            display: flex;
            gap: 12px;
            text-decoration: none;
            color: var(--text-primary);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .related-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        .related-card-info {
            flex: 1;
        }
        .related-card-name {
            font-weight: bold;
            margin-bottom: 4px;
        }
        .related-card-no {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }
        .related-card-price {
            color: var(--accent-color);
            font-weight: bold;
        }
        .related-card-badge {
            display: inline-block;
            background: rgba(139, 92, 246, 0.2);
            color: #8b5cf6;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            margin-left: 8px;
        }
        .price-history-section {
            margin-top: 32px;
        }
        .price-chart-container {
            background: var(--background-secondary);
            border-radius: 8px;
            padding: 16px;
            margin-top: 16px;
        }
        .price-chart-container canvas {
            max-height: 300px;
        }
        .no-history-message {
            text-align: center;
            color: var(--text-secondary);
            padding: 40px 20px;
            background: var(--background-secondary);
            border-radius: 8px;
        }
        @media (max-width: 768px) {
            .card-header {
                flex-direction: column;
                align-items: center;
                text-align: center;
            }
            .card-stats {
                justify-content: center;
            }
            .price-table {
                font-size: 0.9rem;
            }
            .price-table th,
            .price-table td {
                padding: 8px;
            }
            .related-cards-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- ヘッダー -->
    <header class="site-header">
        <div class="header-inner">
            <a href="/" class="site-logo">
                <div class="logo-icon">BS</div>
                <div class="logo-text-group">
                    <span class="logo-text">BSPrice</span>
                    <span class="logo-sub">バトスピ価格比較</span>
                </div>
            </a>
            <nav class="site-nav">
                <a href="/">トップ</a>
                <a href="/ranking">ランキング</a>
                <a href="/shops">ショップ一覧</a>
            </nav>
            <div id="user-menu" class="user-menu"></div>
        </div>
    </header>

    <!-- 広告エリア（ヘッダー下） -->
    <div class="ad-banner ad-header">
        <div class="ad-placeholder">広告</div>
    </div>

    <!-- メインコンテンツ -->
    <main class="main-content">
        <div class="container">
            <!-- パンくずリスト -->
            <div class="breadcrumb">
                <a href="/">トップ</a> &gt; <span id="breadcrumb-card">カード詳細</span>
            </div>

            <!-- ローディング -->
            <div id="loading" class="loading">
                <div class="spinner"></div>
                <p>読み込み中...</p>
            </div>

            <!-- エラー -->
            <div id="error" class="error hidden"></div>

            <!-- カード詳細 -->
            <div id="card-detail" class="card-detail hidden">
                <div class="card-header">
                    <div class="card-image">
                        <img id="card-image" src="" alt="">
                    </div>
                    <div class="card-info">
                        <h1 id="card-name" class="card-name"></h1>
                        <div id="card-number" class="card-number hidden"></div>
                        <div class="card-stats">
                            <div class="stat-item">
                                <div class="stat-label">最安値</div>
                                <div id="min-price" class="stat-value">-</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-label">最高値</div>
                                <div id="max-price" class="stat-value">-</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-label">取扱店舗</div>
                                <div id="shop-count" class="stat-value">-</div>
                            </div>
                        </div>
                        <div class="external-links">
                            <a id="batspi-link" href="#" target="_blank" rel="noopener" class="external-link">
                                バトスピWikiで詳細を見る
                            </a>
                        </div>
                    </div>
                </div>

                <!-- 価格比較テーブル -->
                <h2 class="section-title">ショップ別価格比較</h2>
                <table class="price-table">
                    <thead>
                        <tr>
                            <th>ショップ</th>
                            <th>価格</th>
                            <th>在庫</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody id="price-table-body">
                    </tbody>
                </table>

                <!-- 価格推移グラフ -->
                <div id="price-history-section" class="price-history-section">
                    <h2 class="section-title">価格推移（過去30日）</h2>
                    <div id="price-chart-container" class="price-chart-container">
                        <canvas id="price-chart"></canvas>
                    </div>
                    <div id="no-history-message" class="no-history-message hidden">
                        まだ価格履歴がありません。データは毎日自動で記録されます。
                    </div>
                </div>

                <!-- 関連カード（リバイバル/旧版） -->
                <div id="related-cards-section" class="related-cards-section hidden">
                    <h2 class="section-title">関連カード（リバイバル/旧版）</h2>
                    <div id="related-cards" class="related-cards-grid"></div>
                </div>
            </div>
        </div>
    </main>

    <!-- 広告エリア（フッター上） -->
    <div class="ad-banner ad-footer">
        <div class="ad-placeholder">広告</div>
    </div>

    <!-- フッター -->
    <footer class="site-footer">
        <div class="footer-inner">
            <div class="footer-links">
                <div class="footer-section">
                    <h4>ページ</h4>
                    <a href="/">トップ</a>
                    <a href="/ranking">ランキング</a>
                    <a href="/shops">ショップ一覧</a>
                </div>
                <div class="footer-section">
                    <h4>対応ショップ</h4>
                    <span>カードラッシュ</span>
                    <span>Tier One</span>
                    <span>フルアヘッド</span>
                    <span>ホビーステーション</span>
                    <span>バトスキ</span>
                    <span>遊々亭</span>
                </div>
                <div class="footer-section">
                    <h4>その他</h4>
                    <a href="/login">ログイン</a>
                    <a href="/about">このサイトについて</a>
                    <a href="/privacy">プライバシーポリシー</a>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2026 BSPrice - バトスピ価格比較</p>
                <p class="footer-note">※価格は各ショップの在庫状況により変動します</p>
            </div>
        </div>
    </footer>

    <script src="/static/auth.js"></script>
    <script>
        // カードIDをURLから取得
        const pathParts = window.location.pathname.split('/');
        const cardId = pathParts[pathParts.length - 1];

        // canonicalを動的に更新
        if (cardId && !isNaN(cardId)) {
            const canonicalLink = document.querySelector('link[rel="canonical"]');
            if (canonicalLink) {
                canonicalLink.href = `https://bsprice.net/card/${cardId}`;
            }
        }

        // 要素
        const loadingEl = document.getElementById('loading');
        const errorEl = document.getElementById('error');
        const cardDetailEl = document.getElementById('card-detail');
        const cardNameEl = document.getElementById('card-name');
        const cardNumberEl = document.getElementById('card-number');
        const cardImageEl = document.getElementById('card-image');
        const minPriceEl = document.getElementById('min-price');
        const maxPriceEl = document.getElementById('max-price');
        const shopCountEl = document.getElementById('shop-count');
        const batspiLinkEl = document.getElementById('batspi-link');
        const breadcrumbCardEl = document.getElementById('breadcrumb-card');
        const priceTableBodyEl = document.getElementById('price-table-body');
        const relatedCardsSectionEl = document.getElementById('related-cards-section');
        const relatedCardsEl = document.getElementById('related-cards');

        // 価格フォーマット
        function formatPrice(price) {
            return price.toLocaleString() + '円';
        }

        // カード詳細を読み込む
        async function loadCardDetail() {
            try {
                const response = await fetch(`/api/card/${cardId}`);
                if (!response.ok) {
                    throw new Error('カードが見つかりません');
                }

                const data = await response.json();

                // タイトルを更新
                const cardName = data.base_name || data.card.name;
                document.title = `${cardName} | BSPrice - バトスピ価格比較`;
                cardNameEl.textContent = cardName;
                breadcrumbCardEl.textContent = cardName;

                // カード番号を表示
                if (data.card_no) {
                    cardNumberEl.textContent = data.card_no;
                    cardNumberEl.classList.remove('hidden');
                }

                // 画像（最初の価格データから取得）
                if (data.prices.length > 0 && data.prices[0].image_url) {
                    const imageUrl = data.prices[0].image_url;
                    // ホビステの画像はプロキシ経由
                    if (imageUrl.includes('hobbystation')) {
                        cardImageEl.src = `/api/image-proxy?url=${encodeURIComponent(imageUrl)}`;
                    } else {
                        cardImageEl.src = imageUrl;
                    }
                    cardImageEl.alt = data.card.name;
                } else {
                    cardImageEl.style.display = 'none';
                }

                // 統計
                minPriceEl.textContent = data.min_price ? formatPrice(data.min_price) : '-';
                maxPriceEl.textContent = data.max_price ? formatPrice(data.max_price) : '-';
                shopCountEl.textContent = data.shop_count + '店舗';

                // batspi.comへのリンク
                const batspiSearchUrl = `https://batspi.com/index.php?cmd=read&page=${encodeURIComponent(data.card.name)}&word=${encodeURIComponent(data.card.name)}`;
                batspiLinkEl.href = batspiSearchUrl;

                // 価格テーブル
                const minPrice = data.min_price;
                priceTableBodyEl.innerHTML = data.prices.map(price => {
                    const isLowest = price.price === minPrice;
                    const stockClass = price.stock > 0 ? 'stock-available' : 'stock-soldout';
                    const stockText = price.stock > 0 ? `在庫あり (${price.stock_text || price.stock + '枚'})` : '売り切れ';
                    const shopName = price.site || '不明';
                    const redirectUrl = `/api/redirect?url=${encodeURIComponent(price.url)}&site=${encodeURIComponent(shopName)}&card=${encodeURIComponent(data.card.name)}`;

                    return `
                        <tr>
                            <td><strong>${shopName}</strong></td>
                            <td class="price-value ${isLowest ? 'price-lowest' : ''}">${formatPrice(price.price)}</td>
                            <td><span class="stock-badge ${stockClass}">${stockText}</span></td>
                            <td><a href="${redirectUrl}" target="_blank" rel="noopener" class="shop-link">購入ページへ</a></td>
                        </tr>
                    `;
                }).join('');

                // 関連カード（リバイバル/旧版）を表示
                if (data.related_cards && data.related_cards.length > 0) {
                    relatedCardsEl.innerHTML = data.related_cards.map(card => {
                        const cardNo = card.extracted_card_no || '';
                        const minPrice = card.min_price ? formatPrice(card.min_price) : '価格情報なし';
                        const isRevival = cardNo && cardNo.includes('BSC');
                        const badge = isRevival ? '<span class="related-card-badge">リバイバル</span>' : '';

                        return `
                            <a href="/card/${card.id}" class="related-card">
                                <div class="related-card-info">
                                    <div class="related-card-name">${card.name}${badge}</div>
                                    <div class="related-card-no">${cardNo || '番号なし'}</div>
                                    <div class="related-card-price">最安: ${minPrice}</div>
                                </div>
                            </a>
                        `;
                    }).join('');
                    relatedCardsSectionEl.classList.remove('hidden');
                }

                // 構造化データ (JSON-LD) を動的に追加
                const structuredData = {
                    "@context": "https://schema.org",
                    "@type": "Product",
                    "name": cardName,
                    "description": `バトルスピリッツ カード「${cardName}」の価格比較`,
                    "brand": {
                        "@type": "Brand",
                        "name": "バトルスピリッツ"
                    },
                    "category": "トレーディングカード",
                    "offers": {
                        "@type": "AggregateOffer",
                        "lowPrice": data.min_price || 0,
                        "highPrice": data.max_price || 0,
                        "priceCurrency": "JPY",
                        "offerCount": data.shop_count || 0,
                        "availability": "https://schema.org/InStock"
                    }
                };
                if (data.prices.length > 0 && data.prices[0].image_url) {
                    structuredData.image = data.prices[0].image_url;
                }
                const scriptEl = document.createElement('script');
                scriptEl.type = 'application/ld+json';
                scriptEl.textContent = JSON.stringify(structuredData);
                document.head.appendChild(scriptEl);

                // 表示切り替え
                loadingEl.classList.add('hidden');
                cardDetailEl.classList.remove('hidden');

            } catch (error) {
                console.error('Error loading card detail:', error);
                loadingEl.classList.add('hidden');
                errorEl.textContent = error.message || 'エラーが発生しました';
                errorEl.classList.remove('hidden');
            }
        }

        // 価格履歴グラフを読み込む
        async function loadPriceHistory() {
            try {
                const response = await fetch(`/api/card/${cardId}/history?days=30`);
                if (!response.ok) return;

                const data = await response.json();
                const chartContainer = document.getElementById('price-chart-container');
                const noHistoryMessage = document.getElementById('no-history-message');

                if (!data.history || data.history.length === 0) {
                    chartContainer.classList.add('hidden');
                    noHistoryMessage.classList.remove('hidden');
                    return;
                }

                // ショップごとにデータを整理
                const shopData = {};
                const allDates = new Set();

                data.history.forEach(item => {
                    if (!shopData[item.shop_name]) {
                        shopData[item.shop_name] = {};
                    }
                    shopData[item.shop_name][item.date] = item.price;
                    allDates.add(item.date);
                });

                const sortedDates = Array.from(allDates).sort();
                const colors = [
                    '#3b82f6', '#ef4444', '#22c55e', '#f59e0b',
                    '#8b5cf6', '#ec4899', '#06b6d4'
                ];

                const datasets = Object.keys(shopData).map((shopName, index) => ({
                    label: shopName,
                    data: sortedDates.map(date => shopData[shopName][date] || null),
                    borderColor: colors[index % colors.length],
                    backgroundColor: colors[index % colors.length] + '20',
                    tension: 0.3,
                    fill: false,
                    spanGaps: true
                }));

                new Chart(document.getElementById('price-chart'), {
                    type: 'line',
                    data: {
                        labels: sortedDates.map(d => {
                            const date = new Date(d);
                            return `${date.getMonth() + 1}/${date.getDate()}`;
                        }),
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: { color: '#9ca3af' }
                            }
                        },
                        scales: {
                            x: {
                                ticks: { color: '#9ca3af' },
                                grid: { color: '#374151' }
                            },
                            y: {
                                ticks: {
                                    color: '#9ca3af',
                                    callback: val => val.toLocaleString() + '円'
                                },
                                grid: { color: '#374151' }
                            }
                        }
                    }
                });
            } catch (e) {
                console.error('Failed to load price history:', e);
            }
        }

        // 初期化
        if (cardId && !isNaN(cardId)) {
            loadCardDetail();
            loadPriceHistory();
        } else {
            loadingEl.classList.add('hidden');
            errorEl.textContent = '無効なカードIDです';
            errorEl.classList.remove('hidden');
        }
    </script>
</body>
</html>

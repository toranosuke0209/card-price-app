<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>管理画面 - カード価格比較</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="container">
        <header>
            <h1><a href="/" class="header-link">カード価格比較</a></h1>
            <p class="subtitle">管理者ダッシュボード</p>
            <div id="user-menu"></div>
        </header>

        <div id="admin-content" class="admin-content hidden">
            <!-- 統計情報 -->
            <div class="admin-section">
                <h2>統計情報</h2>
                <div class="admin-stats" id="admin-stats">
                    <div class="stat-card">
                        <div class="stat-value" id="stat-cards">-</div>
                        <div class="stat-label">登録カード</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="stat-prices">-</div>
                        <div class="stat-label">価格データ</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="stat-users">-</div>
                        <div class="stat-label">ユーザー</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="stat-favorites">-</div>
                        <div class="stat-label">お気に入り</div>
                    </div>
                </div>
            </div>

            <!-- カード登録 -->
            <div class="admin-section">
                <h2>カード登録</h2>
                <form id="card-form" class="admin-form" onsubmit="handleAddCard(event)">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="card-name">カード名（必須）</label>
                            <input type="text" id="card-name" required minlength="2" placeholder="例: ジークフリード">
                        </div>
                        <div class="form-group">
                            <label for="card-no">カード番号（任意）</label>
                            <input type="text" id="card-no" placeholder="例: BT01-001">
                        </div>
                    </div>
                    <div class="form-error" id="card-error"></div>
                    <div class="form-success" id="card-success"></div>
                    <button type="submit" class="admin-btn">カードを登録</button>
                </form>
            </div>

            <!-- 人気カード更新 -->
            <div class="admin-section">
                <h2>人気カード管理</h2>
                <p class="section-desc">検索数とクリック数に基づいて人気カードフラグを自動更新します。</p>
                <button class="admin-btn" onclick="handleUpdatePopular()">人気カードを更新</button>
                <div class="form-success" id="popular-success"></div>
            </div>

            <!-- 招待コード管理 -->
            <div class="admin-section">
                <h2>管理者招待コード</h2>
                <button class="admin-btn" onclick="handleGenerateInvite()">新しい招待コードを生成</button>
                <div class="invite-list" id="invite-list"></div>
            </div>
        </div>

        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p>読み込み中...</p>
        </div>

        <div id="not-admin" class="not-admin hidden">
            <p>管理者権限が必要です。</p>
            <a href="/" class="back-link">ホームに戻る</a>
        </div>
    </div>

    <script src="/static/auth.js"></script>
    <script>
        // 初期化
        document.addEventListener('DOMContentLoaded', async () => {
            const loadingEl = document.getElementById('loading');
            const contentEl = document.getElementById('admin-content');
            const notAdminEl = document.getElementById('not-admin');

            // ログインチェック
            if (!Auth.isLoggedIn()) {
                window.location.href = '/login';
                return;
            }

            // ユーザー情報を取得
            const user = await Auth.fetchCurrentUser();
            if (!user || user.role !== 'admin') {
                loadingEl.classList.add('hidden');
                notAdminEl.classList.remove('hidden');
                return;
            }

            // 管理者なのでコンテンツを表示
            loadingEl.classList.add('hidden');
            contentEl.classList.remove('hidden');

            // データ読み込み
            loadStats();
            loadInvites();
        });

        // 統計情報を読み込み
        async function loadStats() {
            try {
                const response = await Auth.authFetch('/api/admin/stats');
                if (!response.ok) return;
                const data = await response.json();
                const stats = data.stats;

                document.getElementById('stat-cards').textContent = (stats.cards || 0).toLocaleString();
                document.getElementById('stat-prices').textContent = (stats.prices || 0).toLocaleString();
                document.getElementById('stat-users').textContent = (stats.users || 0).toLocaleString();
                document.getElementById('stat-favorites').textContent = (stats.favorites || 0).toLocaleString();
            } catch (e) {
                console.error('Failed to load stats:', e);
            }
        }

        // 招待コード一覧を読み込み
        async function loadInvites() {
            try {
                const response = await Auth.authFetch('/api/admin/invites');
                if (!response.ok) return;
                const data = await response.json();
                renderInvites(data.invites);
            } catch (e) {
                console.error('Failed to load invites:', e);
            }
        }

        // 招待コード一覧を描画
        function renderInvites(invites) {
            const listEl = document.getElementById('invite-list');
            if (!invites || invites.length === 0) {
                listEl.innerHTML = '<p class="no-data">招待コードがありません</p>';
                return;
            }

            listEl.innerHTML = invites.map(invite => `
                <div class="invite-item ${invite.is_used ? 'used' : ''}">
                    <div class="invite-code">${escapeHtml(invite.code)}</div>
                    <div class="invite-status">
                        ${invite.is_used
                            ? `<span class="status-used">使用済み</span>`
                            : `<span class="status-unused">未使用</span><button class="copy-btn" onclick="copyInviteCode('${invite.code}')">コピー</button>`
                        }
                    </div>
                    <div class="invite-date">${formatDate(invite.created_at)}</div>
                </div>
            `).join('');
        }

        // カード登録処理
        async function handleAddCard(event) {
            event.preventDefault();
            const errorEl = document.getElementById('card-error');
            const successEl = document.getElementById('card-success');
            errorEl.textContent = '';
            successEl.textContent = '';

            const name = document.getElementById('card-name').value;
            const cardNo = document.getElementById('card-no').value;

            try {
                const response = await Auth.authFetch('/api/admin/cards', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, card_no: cardNo || null })
                });

                const data = await response.json();
                if (!response.ok) {
                    errorEl.textContent = data.detail || '登録に失敗しました';
                    return;
                }

                successEl.textContent = `「${name}」を登録しました`;
                document.getElementById('card-name').value = '';
                document.getElementById('card-no').value = '';
                loadStats();
            } catch (e) {
                errorEl.textContent = e.message;
            }
        }

        // 人気カード更新処理
        async function handleUpdatePopular() {
            const successEl = document.getElementById('popular-success');
            successEl.textContent = '';

            try {
                const response = await Auth.authFetch('/api/admin/update-popular', {
                    method: 'POST'
                });

                const data = await response.json();
                if (!response.ok) {
                    alert(data.detail || '更新に失敗しました');
                    return;
                }

                successEl.textContent = data.message;
            } catch (e) {
                alert(e.message);
            }
        }

        // 招待コード生成処理
        async function handleGenerateInvite() {
            try {
                const response = await Auth.authFetch('/api/admin/invites', {
                    method: 'POST'
                });

                const data = await response.json();
                if (!response.ok) {
                    alert(data.detail || '生成に失敗しました');
                    return;
                }

                alert(`招待コードを生成しました: ${data.invite.code}`);
                loadInvites();
            } catch (e) {
                alert(e.message);
            }
        }

        // 招待コードをコピー
        function copyInviteCode(code) {
            navigator.clipboard.writeText(code).then(() => {
                alert('招待コードをコピーしました');
            }).catch(() => {
                prompt('招待コード:', code);
            });
        }

        // ユーティリティ
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatDate(dateStr) {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            return date.toLocaleString('ja-JP', {
                year: 'numeric',
                month: 'numeric',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>管理画面 | BSPrice - バトスピ価格比較</title>
    <link rel="stylesheet" href="/static/style.css">
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2167017279500518"
         crossorigin="anonymous"></script>
</head>
<body>
    <!-- ヘッダー -->
    <header class="site-header">
        <div class="header-inner">
            <a href="/" class="site-logo">
                <div class="logo-icon">BS</div>
                <div class="logo-text-group">
                    <span class="logo-text">BSPrice</span>
                    <span class="logo-sub">バトスピ価格比較</span>
                </div>
            </a>
            <nav class="site-nav">
                <a href="/">トップ</a>
                <a href="/ranking">ランキング</a>
                <a href="/shops">ショップ一覧</a>
            </nav>
            <div id="user-menu" class="user-menu"></div>
        </div>
    </header>

    <!-- メインコンテンツ -->
    <main class="main-content">
        <div class="container">
            <div class="search-section" style="padding-bottom: 10px;">
                <h1 class="search-title" style="font-size: 1.5rem;">管理者ダッシュボード</h1>
            </div>

            <!-- TODO リマインダー -->
            <div class="admin-reminder">
                <div class="reminder-icon">!</div>
                <div class="reminder-content">
                    <div class="reminder-title">TODO: 新弾追加プログラム作成</div>
                    <div class="reminder-desc">
                        <strong>2月14日</strong>に新弾が発売予定。<br>
                        新弾のカードのみを追加するプログラムを作成すること。
                    </div>
                </div>
            </div>

            <div id="admin-content" class="admin-content hidden">
            <!-- 統計情報 -->
            <div class="admin-section">
                <h2>統計情報</h2>
                <div class="admin-stats" id="admin-stats">
                    <div class="stat-card">
                        <div class="stat-value" id="stat-cards">-</div>
                        <div class="stat-label">登録カード</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="stat-prices">-</div>
                        <div class="stat-label">価格データ</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="stat-users">-</div>
                        <div class="stat-label">ユーザー</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="stat-favorites">-</div>
                        <div class="stat-label">お気に入り</div>
                    </div>
                </div>
            </div>

            <!-- カード登録 -->
            <div class="admin-section">
                <h2>カード登録</h2>
                <form id="card-form" class="admin-form" onsubmit="handleAddCard(event)">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="card-name">カード名（必須）</label>
                            <input type="text" id="card-name" required minlength="2" placeholder="例: ジークフリード">
                        </div>
                        <div class="form-group">
                            <label for="card-no">カード番号（任意）</label>
                            <input type="text" id="card-no" placeholder="例: BT01-001">
                        </div>
                    </div>
                    <div class="form-error" id="card-error"></div>
                    <div class="form-success" id="card-success"></div>
                    <button type="submit" class="admin-btn">カードを登録</button>
                </form>
            </div>

            <!-- カード一覧 -->
            <div class="admin-section">
                <h2>登録カード一覧</h2>
                <p class="section-desc">登録されているカードの管理と価格取得ができます。</p>
                <div class="form-row" style="margin-bottom: 15px;">
                    <div class="form-group" style="flex: 1;">
                        <input type="text" id="card-search" placeholder="カード名で検索..." onkeyup="handleCardSearch(event)">
                    </div>
                    <div class="form-group" style="flex: 0;">
                        <button class="admin-btn" onclick="loadCards()">検索</button>
                    </div>
                </div>
                <div id="card-list" class="card-list"></div>
                <div id="card-pagination" class="pagination"></div>
            </div>

            <!-- 人気キーワード管理 -->
            <div class="admin-section">
                <h2>人気キーワード管理</h2>
                <p class="section-desc">トップページに表示される検索キーワードを管理します。価格は1日2回自動更新されます。</p>
                <form id="keyword-form" class="admin-form" onsubmit="handleAddKeyword(event)">
                    <div class="form-row">
                        <div class="form-group" style="flex: 1;">
                            <label for="new-keyword">キーワード追加</label>
                            <input type="text" id="new-keyword" required placeholder="例: ジークフリード">
                        </div>
                        <div class="form-group" style="flex: 0; padding-top: 24px;">
                            <button type="submit" class="admin-btn">追加</button>
                        </div>
                    </div>
                    <div class="form-error" id="keyword-error"></div>
                </form>
                <div style="margin: 15px 0;">
                    <button class="admin-btn" onclick="updateAllKeywordPrices()" id="update-all-btn">全キーワードの価格を更新</button>
                    <span id="update-all-status" style="margin-left: 10px; color: #666;"></span>
                </div>
                <div class="keyword-list" id="keyword-list"></div>
            </div>

            <!-- Amazon商品管理 -->
            <div class="admin-section">
                <h2>Amazon商品管理</h2>
                <p class="section-desc">検索結果に表示するAmazon商品を管理します。</p>
                <form id="amazon-form" class="admin-form" onsubmit="handleAddAmazonProduct(event)">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="amazon-url">Amazon URL</label>
                            <input type="url" id="amazon-url" required placeholder="https://www.amazon.co.jp/dp/...">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="amazon-name">商品名</label>
                            <input type="text" id="amazon-name" required placeholder="商品名を入力">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="amazon-price">価格（税込）</label>
                            <input type="number" id="amazon-price" required placeholder="5390">
                        </div>
                        <div class="form-group">
                            <label for="amazon-image">画像URL</label>
                            <input type="url" id="amazon-image" required placeholder="https://m.media-amazon.com/...">
                        </div>
                    </div>
                    <div class="form-error" id="amazon-error"></div>
                    <div class="form-success" id="amazon-success"></div>
                    <button type="submit" class="admin-btn">商品を追加</button>
                </form>
                <div class="amazon-product-list" id="amazon-product-list"></div>
            </div>

            <!-- 楽天商品管理 -->
            <div class="admin-section">
                <h2>楽天商品管理</h2>
                <p class="section-desc">検索結果に表示する楽天商品を管理します。</p>
                <form id="rakuten-form" class="admin-form" onsubmit="handleAddRakutenProduct(event)">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="rakuten-url">楽天アフィリエイトURL</label>
                            <input type="url" id="rakuten-url" required placeholder="https://hb.afl.rakuten.co.jp/...">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="rakuten-name">商品名</label>
                            <input type="text" id="rakuten-name" required placeholder="商品名を入力">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="rakuten-price">価格（税込）</label>
                            <input type="number" id="rakuten-price" required placeholder="5040">
                        </div>
                        <div class="form-group">
                            <label for="rakuten-image">画像URL</label>
                            <input type="url" id="rakuten-image" required placeholder="https://...">
                        </div>
                    </div>
                    <div class="form-error" id="rakuten-error"></div>
                    <div class="form-success" id="rakuten-success"></div>
                    <button type="submit" class="admin-btn">商品を追加</button>
                </form>
                <div class="rakuten-product-list" id="rakuten-product-list"></div>
            </div>

            <!-- 人気カード更新 -->
            <div class="admin-section">
                <h2>人気カード管理</h2>
                <p class="section-desc">検索数とクリック数に基づいて人気カードフラグを自動更新します。</p>
                <button class="admin-btn" onclick="handleUpdatePopular()">人気カードを更新</button>
                <div class="form-success" id="popular-success"></div>
            </div>

            <!-- 招待コード管理 -->
            <div class="admin-section">
                <h2>管理者招待コード</h2>
                <button class="admin-btn" onclick="handleGenerateInvite()">新しい招待コードを生成</button>
                <div class="invite-list" id="invite-list"></div>
            </div>
        </div>

        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p>読み込み中...</p>
        </div>

        <div id="not-admin" class="not-admin hidden">
            <p>管理者権限が必要です。</p>
            <a href="/" class="back-link">ホームに戻る</a>
        </div>
        </div>
    </main>

    <!-- フッター -->
    <footer class="site-footer">
        <div class="footer-inner">
            <div class="footer-links">
                <div class="footer-section">
                    <h4>ページ</h4>
                    <a href="/">トップ</a>
                    <a href="/ranking">ランキング</a>
                    <a href="/shops">ショップ一覧</a>
                </div>
                <div class="footer-section">
                    <h4>対応ショップ</h4>
                    <span>カードラッシュ</span>
                    <span>Tier One</span>
                    <span>フルアヘッド</span>
                    <span>ホビーステーション</span>
                    <span>バトスキ</span>
                    <span>遊々亭</span>
                </div>
                <div class="footer-section">
                    <h4>その他</h4>
                    <a href="/login">ログイン</a>
                    <a href="/about">このサイトについて</a>
                    <a href="/privacy">プライバシーポリシー</a>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2026 BSPrice - バトスピ価格比較</p>
                <p class="footer-note">※価格は各ショップの在庫状況により変動します</p>
            </div>
        </div>
    </footer>

    <script src="/static/auth.js"></script>
    <script>
        // 初期化
        document.addEventListener('DOMContentLoaded', async () => {
            const loadingEl = document.getElementById('loading');
            const contentEl = document.getElementById('admin-content');
            const notAdminEl = document.getElementById('not-admin');

            // ログインチェック
            if (!Auth.isLoggedIn()) {
                window.location.href = '/login';
                return;
            }

            // ユーザー情報を取得
            const user = await Auth.fetchCurrentUser();
            if (!user || user.role !== 'admin') {
                loadingEl.classList.add('hidden');
                notAdminEl.classList.remove('hidden');
                return;
            }

            // 管理者なのでコンテンツを表示
            loadingEl.classList.add('hidden');
            contentEl.classList.remove('hidden');

            // データ読み込み
            loadStats();
            loadInvites();
            loadKeywords();
            loadCards();
            loadAmazonProducts();
            loadRakutenProducts();
        });

        // 統計情報を読み込み
        async function loadStats() {
            try {
                const response = await Auth.authFetch('/api/admin/stats');
                if (!response.ok) return;
                const data = await response.json();
                const stats = data.stats;

                document.getElementById('stat-cards').textContent = (stats.cards || 0).toLocaleString();
                document.getElementById('stat-prices').textContent = (stats.prices || 0).toLocaleString();
                document.getElementById('stat-users').textContent = (stats.users || 0).toLocaleString();
                document.getElementById('stat-favorites').textContent = (stats.favorites || 0).toLocaleString();
            } catch (e) {
                console.error('Failed to load stats:', e);
            }
        }

        // 招待コード一覧を読み込み
        async function loadInvites() {
            try {
                const response = await Auth.authFetch('/api/admin/invites');
                if (!response.ok) return;
                const data = await response.json();
                renderInvites(data.invites);
            } catch (e) {
                console.error('Failed to load invites:', e);
            }
        }

        // 招待コード一覧を描画
        function renderInvites(invites) {
            const listEl = document.getElementById('invite-list');
            if (!invites || invites.length === 0) {
                listEl.innerHTML = '<p class="no-data">招待コードがありません</p>';
                return;
            }

            listEl.innerHTML = invites.map(invite => `
                <div class="invite-item ${invite.is_used ? 'used' : ''}">
                    <div class="invite-code">${escapeHtml(invite.code)}</div>
                    <div class="invite-status">
                        ${invite.is_used
                            ? `<span class="status-used">使用済み</span>`
                            : `<span class="status-unused">未使用</span><button class="copy-btn" onclick="copyInviteCode('${invite.code}')">コピー</button>`
                        }
                    </div>
                    <div class="invite-date">${formatDate(invite.created_at)}</div>
                </div>
            `).join('');
        }

        // カード登録処理
        async function handleAddCard(event) {
            event.preventDefault();
            const errorEl = document.getElementById('card-error');
            const successEl = document.getElementById('card-success');
            errorEl.textContent = '';
            successEl.textContent = '';

            const name = document.getElementById('card-name').value;
            const cardNo = document.getElementById('card-no').value;

            try {
                const response = await Auth.authFetch('/api/admin/cards', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, card_no: cardNo || null })
                });

                const data = await response.json();
                if (!response.ok) {
                    errorEl.textContent = data.detail || '登録に失敗しました';
                    return;
                }

                successEl.textContent = `「${name}」を登録しました`;
                document.getElementById('card-name').value = '';
                document.getElementById('card-no').value = '';
                loadStats();
                loadCards(); // カード一覧を更新
            } catch (e) {
                errorEl.textContent = e.message;
            }
        }

        // =================================================================
        // カード一覧管理
        // =================================================================

        let cardCurrentPage = 0;
        const cardPageSize = 20;

        // カード一覧を読み込み
        async function loadCards(page = 0) {
            cardCurrentPage = page;
            const search = document.getElementById('card-search').value.trim();
            const offset = page * cardPageSize;

            try {
                const params = new URLSearchParams({
                    limit: cardPageSize,
                    offset: offset
                });
                if (search) params.append('search', search);

                const response = await Auth.authFetch(`/api/admin/cards?${params}`);
                if (!response.ok) return;
                const data = await response.json();
                renderCards(data.cards, data.total);
            } catch (e) {
                console.error('Failed to load cards:', e);
            }
        }

        // 検索時のEnterキー処理
        function handleCardSearch(event) {
            if (event.key === 'Enter') {
                loadCards(0);
            }
        }

        // カード一覧を描画
        function renderCards(cards, total) {
            const listEl = document.getElementById('card-list');
            const paginationEl = document.getElementById('card-pagination');

            if (!cards || cards.length === 0) {
                listEl.innerHTML = '<p class="no-data">カードがありません</p>';
                paginationEl.innerHTML = '';
                return;
            }

            listEl.innerHTML = `
                <div class="card-list-header">
                    <span class="card-col-id">ID</span>
                    <span class="card-col-name">カード名</span>
                    <span class="card-col-no">番号</span>
                    <span class="card-col-prices">価格数</span>
                    <span class="card-col-updated">最終取得</span>
                    <span class="card-col-actions">操作</span>
                </div>
                ${cards.map(card => `
                    <div class="card-list-item" data-id="${card.id}">
                        <span class="card-col-id">${card.id}</span>
                        <span class="card-col-name">${escapeHtml(card.name)}</span>
                        <span class="card-col-no">${card.card_no || '-'}</span>
                        <span class="card-col-prices">${card.price_count || 0}</span>
                        <span class="card-col-updated">${card.last_price_fetch_at ? formatDate(card.last_price_fetch_at) : '未取得'}</span>
                        <span class="card-col-actions">
                            <button class="card-btn fetch-btn" onclick="fetchCardPrices(${card.id}, '${escapeHtml(card.name)}')" title="価格を取得">価格取得</button>
                            <button class="card-btn delete-btn" onclick="deleteCard(${card.id}, '${escapeHtml(card.name)}')" title="削除">×</button>
                        </span>
                    </div>
                `).join('')}
            `;

            // ページネーション
            const totalPages = Math.ceil(total / cardPageSize);
            if (totalPages <= 1) {
                paginationEl.innerHTML = `<span class="page-info">${total}件</span>`;
                return;
            }

            let paginationHtml = `<span class="page-info">${total}件中 ${cardCurrentPage * cardPageSize + 1}-${Math.min((cardCurrentPage + 1) * cardPageSize, total)}件</span>`;

            if (cardCurrentPage > 0) {
                paginationHtml += `<button class="page-btn" onclick="loadCards(${cardCurrentPage - 1})">前へ</button>`;
            }

            paginationHtml += `<span class="page-current">${cardCurrentPage + 1} / ${totalPages}</span>`;

            if (cardCurrentPage < totalPages - 1) {
                paginationHtml += `<button class="page-btn" onclick="loadCards(${cardCurrentPage + 1})">次へ</button>`;
            }

            paginationEl.innerHTML = paginationHtml;
        }

        // カードの価格を取得
        async function fetchCardPrices(cardId, cardName) {
            if (!confirm(`「${cardName}」の価格を各ショップから取得します。\n数十秒かかる場合があります。続行しますか？`)) return;

            const btn = event.target;
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = '取得中...';

            try {
                const response = await Auth.authFetch(`/api/admin/cards/${cardId}/fetch-prices`, {
                    method: 'POST'
                });

                const data = await response.json();
                if (!response.ok) {
                    alert(data.detail || '価格取得に失敗しました');
                    return;
                }

                let resultMsg = `「${cardName}」の価格取得完了\n\n`;
                resultMsg += `取得: ${data.stats.total}件\n`;
                resultMsg += `更新: ${data.stats.new}件\n\n`;
                if (data.stats.shops) {
                    resultMsg += `【ショップ別】\n`;
                    for (const [shop, stat] of Object.entries(data.stats.shops)) {
                        resultMsg += `${shop}: ${stat.found}件取得, ${stat.saved}件更新\n`;
                    }
                }
                alert(resultMsg);

                loadCards(cardCurrentPage);
                loadStats();
            } catch (e) {
                alert(e.message);
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
            }
        }

        // カードを削除
        async function deleteCard(cardId, cardName) {
            if (!confirm(`「${cardName}」を削除しますか？\n関連する価格データも全て削除されます。`)) return;

            try {
                const response = await Auth.authFetch(`/api/admin/cards/${cardId}`, {
                    method: 'DELETE'
                });

                const data = await response.json();
                if (!response.ok) {
                    alert(data.detail || '削除に失敗しました');
                    return;
                }

                alert(data.message);
                loadCards(cardCurrentPage);
                loadStats();
            } catch (e) {
                alert(e.message);
            }
        }

        // =================================================================
        // 人気キーワード管理
        // =================================================================

        // キーワード一覧を読み込み
        async function loadKeywords() {
            try {
                const response = await Auth.authFetch('/api/admin/featured-keywords');
                if (!response.ok) return;
                const data = await response.json();
                renderKeywords(data.keywords);
            } catch (e) {
                console.error('Failed to load keywords:', e);
            }
        }

        // キーワード一覧を描画
        function renderKeywords(keywords) {
            const listEl = document.getElementById('keyword-list');
            if (!keywords || keywords.length === 0) {
                listEl.innerHTML = '<p class="no-data">キーワードがありません</p>';
                return;
            }

            listEl.innerHTML = keywords.map((kw, index) => `
                <div class="keyword-item ${kw.is_active ? '' : 'inactive'}" data-id="${kw.id}">
                    <span class="keyword-order">${index + 1}</span>
                    <span class="keyword-text">${escapeHtml(kw.keyword)}</span>
                    <div class="keyword-actions">
                        <button class="keyword-btn update-price-btn" onclick="updateKeywordPrices(${kw.id}, '${escapeHtml(kw.keyword)}')" title="価格を即座に更新">価格更新</button>
                        <button class="keyword-btn toggle-btn" onclick="toggleKeyword(${kw.id}, ${kw.is_active})" title="${kw.is_active ? '非表示にする' : '表示する'}">
                            ${kw.is_active ? '表示中' : '非表示'}
                        </button>
                        <button class="keyword-btn move-btn" onclick="moveKeyword(${kw.id}, -1)" title="上に移動" ${index === 0 ? 'disabled' : ''}>↑</button>
                        <button class="keyword-btn move-btn" onclick="moveKeyword(${kw.id}, 1)" title="下に移動" ${index === keywords.length - 1 ? 'disabled' : ''}>↓</button>
                        <button class="keyword-btn delete-btn" onclick="deleteKeyword(${kw.id})" title="削除">×</button>
                    </div>
                </div>
            `).join('');
        }

        // キーワード追加処理
        async function handleAddKeyword(event) {
            event.preventDefault();
            const errorEl = document.getElementById('keyword-error');
            errorEl.textContent = '';

            const keyword = document.getElementById('new-keyword').value.trim();
            if (!keyword) return;

            try {
                const response = await Auth.authFetch('/api/admin/featured-keywords', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ keyword })
                });

                const data = await response.json();
                if (!response.ok) {
                    errorEl.textContent = data.detail || '追加に失敗しました';
                    return;
                }

                document.getElementById('new-keyword').value = '';
                loadKeywords();
            } catch (e) {
                errorEl.textContent = e.message;
            }
        }

        // キーワードの表示/非表示を切り替え
        async function toggleKeyword(id, currentActive) {
            try {
                const response = await Auth.authFetch(`/api/admin/featured-keywords/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ is_active: currentActive ? 0 : 1 })
                });

                if (!response.ok) {
                    const data = await response.json();
                    alert(data.detail || '更新に失敗しました');
                    return;
                }

                loadKeywords();
            } catch (e) {
                alert(e.message);
            }
        }

        // キーワードを移動（並び替え）
        let currentKeywords = [];
        async function moveKeyword(id, direction) {
            // 現在の一覧を取得
            const response = await Auth.authFetch('/api/admin/featured-keywords');
            if (!response.ok) return;
            const data = await response.json();
            currentKeywords = data.keywords;

            const index = currentKeywords.findIndex(k => k.id === id);
            if (index === -1) return;

            const newIndex = index + direction;
            if (newIndex < 0 || newIndex >= currentKeywords.length) return;

            // 配列内で入れ替え
            [currentKeywords[index], currentKeywords[newIndex]] = [currentKeywords[newIndex], currentKeywords[index]];

            // 新しい順序でAPIに送信
            const newOrder = currentKeywords.map(k => k.id);
            try {
                const reorderResponse = await Auth.authFetch('/api/admin/featured-keywords/reorder', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ keyword_ids: newOrder })
                });

                if (!reorderResponse.ok) {
                    const errData = await reorderResponse.json();
                    alert(errData.detail || '並び替えに失敗しました');
                    return;
                }

                loadKeywords();
            } catch (e) {
                alert(e.message);
            }
        }

        // キーワードを削除
        async function deleteKeyword(id) {
            if (!confirm('このキーワードを削除しますか？')) return;

            try {
                const response = await Auth.authFetch(`/api/admin/featured-keywords/${id}`, {
                    method: 'DELETE'
                });

                if (!response.ok) {
                    const data = await response.json();
                    alert(data.detail || '削除に失敗しました');
                    return;
                }

                loadKeywords();
            } catch (e) {
                alert(e.message);
            }
        }

        // 単一キーワードの価格を更新
        async function updateKeywordPrices(id, keyword) {
            if (!confirm(`「${keyword}」の価格を各ショップから取得します。\n数十秒かかる場合があります。続行しますか？`)) return;

            // ボタンを無効化
            const btn = event.target;
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = '更新中...';

            try {
                const response = await Auth.authFetch(`/api/admin/featured-keywords/${id}/update-prices`, {
                    method: 'POST'
                });

                const data = await response.json();
                if (!response.ok) {
                    alert(data.detail || '価格更新に失敗しました');
                    return;
                }

                // 結果を表示
                let resultMsg = `「${keyword}」の価格更新完了\n\n`;
                resultMsg += `取得: ${data.stats.total}件\n`;
                resultMsg += `更新: ${data.stats.new}件\n\n`;
                resultMsg += `【ショップ別】\n`;
                for (const [shop, stat] of Object.entries(data.stats.shops)) {
                    resultMsg += `${shop}: ${stat.found}件取得, ${stat.saved}件更新\n`;
                }
                alert(resultMsg);

            } catch (e) {
                alert(e.message);
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
            }
        }

        // 全キーワードの価格を更新
        async function updateAllKeywordPrices() {
            if (!confirm('全ての人気キーワードの価格を更新します。\n数分かかる場合があります。続行しますか？')) return;

            const btn = document.getElementById('update-all-btn');
            const statusEl = document.getElementById('update-all-status');
            btn.disabled = true;
            btn.textContent = '更新中...';
            statusEl.textContent = '価格を取得しています...';

            try {
                const response = await Auth.authFetch('/api/admin/featured-keywords/update-all-prices', {
                    method: 'POST'
                });

                const data = await response.json();
                if (!response.ok) {
                    alert(data.detail || '価格更新に失敗しました');
                    statusEl.textContent = 'エラーが発生しました';
                    return;
                }

                statusEl.textContent = `完了: ${data.stats.keywords}キーワード, ${data.stats.total}件取得, ${data.stats.new}件更新`;
                alert(`価格更新完了\n\nキーワード数: ${data.stats.keywords}\n取得件数: ${data.stats.total}\n更新件数: ${data.stats.new}`);

            } catch (e) {
                alert(e.message);
                statusEl.textContent = 'エラーが発生しました';
            } finally {
                btn.disabled = false;
                btn.textContent = '全キーワードの価格を更新';
            }
        }

        // =================================================================
        // Amazon商品管理
        // =================================================================

        // Amazon商品一覧を読み込み
        async function loadAmazonProducts() {
            try {
                const response = await Auth.authFetch('/api/admin/amazon-products');
                if (!response.ok) return;
                const data = await response.json();
                renderAmazonProducts(data.products);
            } catch (e) {
                console.error('Failed to load Amazon products:', e);
            }
        }

        // Amazon商品一覧を描画
        function renderAmazonProducts(products) {
            const listEl = document.getElementById('amazon-product-list');
            if (!products || products.length === 0) {
                listEl.innerHTML = '<p class="no-data">商品がありません</p>';
                return;
            }

            listEl.innerHTML = products.map((product, index) => `
                <div class="amazon-item ${product.is_active ? '' : 'inactive'}" data-id="${product.id}">
                    <a href="${escapeHtml(product.affiliate_url)}" target="_blank" rel="noopener"><img src="${escapeHtml(product.image_url)}" alt="${escapeHtml(product.name)}" class="amazon-item-img" onerror="this.style.display='none'"></a>
                    <div class="amazon-item-info">
                        <a href="${escapeHtml(product.affiliate_url)}" target="_blank" rel="noopener" style="color:#4fc3f7;text-decoration:none"><div class="amazon-item-name">${escapeHtml(product.name)}</div></a>
                        <div class="amazon-item-price">${product.price_text}</div>
                    </div>
                    <div class="amazon-item-actions">
                        <button class="keyword-btn" onclick="editAmazonProduct(${product.id})" style="background:#2196F3">編集</button>
                        <button class="keyword-btn toggle-btn" onclick="toggleAmazonProduct(${product.id}, ${product.is_active})">
                            ${product.is_active ? '表示中' : '非表示'}
                        </button>
                        <button class="keyword-btn move-btn" onclick="moveAmazonProduct(${product.id}, -1)" ${index === 0 ? 'disabled' : ''}>↑</button>
                        <button class="keyword-btn move-btn" onclick="moveAmazonProduct(${product.id}, 1)" ${index === products.length - 1 ? 'disabled' : ''}>↓</button>
                        <button class="keyword-btn delete-btn" onclick="deleteAmazonProduct(${product.id})">×</button>
                    </div>
                </div>
            `).join('');
        }

        // Amazon商品を編集
        async function editAmazonProduct(productId) {
            const item = document.querySelector(`.amazon-item[data-id="${productId}"]`);
            if (!item) return;

            const nameEl = item.querySelector('.amazon-item-name');
            const priceEl = item.querySelector('.amazon-item-price');
            const imgEl = item.querySelector('.amazon-item-img');

            const currentName = nameEl ? nameEl.textContent : '';
            const currentPrice = priceEl ? priceEl.textContent.replace(/[^0-9]/g, '') : '';
            const currentImage = imgEl ? imgEl.src : '';

            const newName = prompt('商品名:', currentName);
            if (newName === null) return;

            const newPrice = prompt('価格:', currentPrice);
            if (newPrice === null) return;

            const newImageUrl = prompt('画像URL:', currentImage);
            if (newImageUrl === null) return;

            try {
                const response = await Auth.authFetch(`/api/admin/amazon-products/${productId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: newName || undefined,
                        price: newPrice ? parseInt(newPrice) : undefined,
                        image_url: newImageUrl || undefined
                    })
                });
                if (response.ok) {
                    alert('更新しました');
                    loadAmazonProducts();
                } else {
                    const err = await response.json();
                    alert('エラー: ' + (err.detail || '更新失敗'));
                }
            } catch (e) {
                alert('エラー: ' + e.message);
            }
        }

        // Amazon商品を追加
        async function handleAddAmazonProduct(event) {
            event.preventDefault();
            const errorEl = document.getElementById('amazon-error');
            const successEl = document.getElementById('amazon-success');
            errorEl.textContent = '';
            successEl.textContent = '';

            const url = document.getElementById('amazon-url').value;
            const name = document.getElementById('amazon-name').value;
            const price = parseInt(document.getElementById('amazon-price').value);
            const imageUrl = document.getElementById('amazon-image').value;

            try {
                const response = await Auth.authFetch('/api/admin/amazon-products', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url, name, price, image_url: imageUrl })
                });

                const data = await response.json();
                if (!response.ok) {
                    errorEl.textContent = data.detail || '追加に失敗しました';
                    return;
                }

                successEl.textContent = `「${name}」を追加しました`;
                document.getElementById('amazon-url').value = '';
                document.getElementById('amazon-name').value = '';
                document.getElementById('amazon-price').value = '';
                document.getElementById('amazon-image').value = '';
                loadAmazonProducts();
            } catch (e) {
                errorEl.textContent = e.message;
            }
        }

        // Amazon商品の表示/非表示切り替え
        async function toggleAmazonProduct(id, currentActive) {
            try {
                const response = await Auth.authFetch(`/api/admin/amazon-products/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ is_active: currentActive ? 0 : 1 })
                });

                if (!response.ok) {
                    const data = await response.json();
                    alert(data.detail || '更新に失敗しました');
                    return;
                }

                loadAmazonProducts();
            } catch (e) {
                alert(e.message);
            }
        }

        // Amazon商品を移動（並び替え）
        let currentAmazonProducts = [];
        async function moveAmazonProduct(id, direction) {
            const response = await Auth.authFetch('/api/admin/amazon-products');
            if (!response.ok) return;
            const data = await response.json();
            currentAmazonProducts = data.products;

            const index = currentAmazonProducts.findIndex(p => p.id === id);
            if (index === -1) return;

            const newIndex = index + direction;
            if (newIndex < 0 || newIndex >= currentAmazonProducts.length) return;

            [currentAmazonProducts[index], currentAmazonProducts[newIndex]] = [currentAmazonProducts[newIndex], currentAmazonProducts[index]];

            const newOrder = currentAmazonProducts.map(p => p.id);
            try {
                const reorderResponse = await Auth.authFetch('/api/admin/amazon-products/reorder', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ product_ids: newOrder })
                });

                if (!reorderResponse.ok) {
                    const errData = await reorderResponse.json();
                    alert(errData.detail || '並び替えに失敗しました');
                    return;
                }

                loadAmazonProducts();
            } catch (e) {
                alert(e.message);
            }
        }

        // Amazon商品を削除
        async function deleteAmazonProduct(id) {
            if (!confirm('この商品を削除しますか？')) return;

            try {
                const response = await Auth.authFetch(`/api/admin/amazon-products/${id}`, {
                    method: 'DELETE'
                });

                if (!response.ok) {
                    const data = await response.json();
                    alert(data.detail || '削除に失敗しました');
                    return;
                }

                loadAmazonProducts();
            } catch (e) {
                alert(e.message);
            }
        }

        // =================================================================
        // 楽天商品管理
        // =================================================================

        // 楽天商品一覧を読み込み
        async function loadRakutenProducts() {
            try {
                const response = await Auth.authFetch('/api/admin/rakuten-products');
                if (!response.ok) return;
                const data = await response.json();
                renderRakutenProducts(data.products);
            } catch (e) {
                console.error('Failed to load Rakuten products:', e);
            }
        }

        // 楽天商品一覧を描画
        function renderRakutenProducts(products) {
            const listEl = document.getElementById('rakuten-product-list');
            if (!products || products.length === 0) {
                listEl.innerHTML = '<p class="no-data">商品がありません</p>';
                return;
            }

            listEl.innerHTML = products.map((product, index) => `
                <div class="amazon-item ${product.is_active ? '' : 'inactive'}" data-id="${product.id}">
                    <a href="${escapeHtml(product.affiliate_url)}" target="_blank" rel="noopener"><img src="${escapeHtml(product.image_url)}" alt="${escapeHtml(product.name)}" class="amazon-item-img" onerror="this.style.display='none'"></a>
                    <div class="amazon-item-info">
                        <a href="${escapeHtml(product.affiliate_url)}" target="_blank" rel="noopener" style="color:#bf0000;text-decoration:none"><div class="amazon-item-name">${escapeHtml(product.name)}</div></a>
                        <div class="amazon-item-price">${product.price_text}</div>
                    </div>
                    <div class="amazon-item-actions">
                        <button class="keyword-btn" onclick="editRakutenProduct(${product.id})" style="background:#2196F3">編集</button>
                        <button class="keyword-btn toggle-btn" onclick="toggleRakutenProduct(${product.id}, ${product.is_active})">
                            ${product.is_active ? '表示中' : '非表示'}
                        </button>
                        <button class="keyword-btn move-btn" onclick="moveRakutenProduct(${product.id}, -1)" ${index === 0 ? 'disabled' : ''}>↑</button>
                        <button class="keyword-btn move-btn" onclick="moveRakutenProduct(${product.id}, 1)" ${index === products.length - 1 ? 'disabled' : ''}>↓</button>
                        <button class="keyword-btn delete-btn" onclick="deleteRakutenProduct(${product.id})">×</button>
                    </div>
                </div>
            `).join('');
        }

        // 楽天商品を編集
        async function editRakutenProduct(productId) {
            const item = document.querySelector(`.amazon-item[data-id="${productId}"]`);
            if (!item) return;

            const nameEl = item.querySelector('.amazon-item-name');
            const priceEl = item.querySelector('.amazon-item-price');
            const imgEl = item.querySelector('.amazon-item-img');

            const currentName = nameEl ? nameEl.textContent : '';
            const currentPrice = priceEl ? priceEl.textContent.replace(/[^0-9]/g, '') : '';
            const currentImage = imgEl ? imgEl.src : '';

            const newName = prompt('商品名:', currentName);
            if (newName === null) return;

            const newPrice = prompt('価格:', currentPrice);
            if (newPrice === null) return;

            const newImageUrl = prompt('画像URL:', currentImage);
            if (newImageUrl === null) return;

            try {
                const response = await Auth.authFetch(`/api/admin/rakuten-products/${productId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: newName || undefined,
                        price: newPrice ? parseInt(newPrice) : undefined,
                        image_url: newImageUrl || undefined
                    })
                });
                if (response.ok) {
                    alert('更新しました');
                    loadRakutenProducts();
                } else {
                    const err = await response.json();
                    alert('エラー: ' + (err.detail || '更新失敗'));
                }
            } catch (e) {
                alert('エラー: ' + e.message);
            }
        }

        // 楽天商品を追加
        async function handleAddRakutenProduct(event) {
            event.preventDefault();
            const errorEl = document.getElementById('rakuten-error');
            const successEl = document.getElementById('rakuten-success');
            errorEl.textContent = '';
            successEl.textContent = '';

            const affiliateUrl = document.getElementById('rakuten-url').value;
            const name = document.getElementById('rakuten-name').value;
            const price = parseInt(document.getElementById('rakuten-price').value);
            const imageUrl = document.getElementById('rakuten-image').value;

            try {
                const response = await Auth.authFetch('/api/admin/rakuten-products', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, price, image_url: imageUrl, affiliate_url: affiliateUrl })
                });

                const data = await response.json();
                if (!response.ok) {
                    errorEl.textContent = data.detail || '追加に失敗しました';
                    return;
                }

                successEl.textContent = `「${name}」を追加しました`;
                document.getElementById('rakuten-url').value = '';
                document.getElementById('rakuten-name').value = '';
                document.getElementById('rakuten-price').value = '';
                document.getElementById('rakuten-image').value = '';
                loadRakutenProducts();
            } catch (e) {
                errorEl.textContent = e.message;
            }
        }

        // 楽天商品の表示/非表示切り替え
        async function toggleRakutenProduct(id, currentActive) {
            try {
                const response = await Auth.authFetch(`/api/admin/rakuten-products/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ is_active: currentActive ? 0 : 1 })
                });

                if (!response.ok) {
                    const data = await response.json();
                    alert(data.detail || '更新に失敗しました');
                    return;
                }

                loadRakutenProducts();
            } catch (e) {
                alert(e.message);
            }
        }

        // 楽天商品の並び替え
        let rakutenProducts = [];
        async function moveRakutenProduct(id, direction) {
            // 現在の商品一覧を取得
            const response = await Auth.authFetch('/api/admin/rakuten-products');
            if (!response.ok) return;
            const data = await response.json();
            rakutenProducts = data.products;

            const currentIndex = rakutenProducts.findIndex(p => p.id === id);
            const newIndex = currentIndex + direction;

            if (newIndex < 0 || newIndex >= rakutenProducts.length) return;

            // 入れ替え
            [rakutenProducts[currentIndex], rakutenProducts[newIndex]] =
            [rakutenProducts[newIndex], rakutenProducts[currentIndex]];

            // 新しい順序をAPIに送信
            const productIds = rakutenProducts.map(p => p.id);
            await Auth.authFetch('/api/admin/rakuten-products/reorder', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ product_ids: productIds })
            });

            loadRakutenProducts();
        }

        // 楽天商品を削除
        async function deleteRakutenProduct(id) {
            if (!confirm('この商品を削除しますか？')) return;

            try {
                const response = await Auth.authFetch(`/api/admin/rakuten-products/${id}`, {
                    method: 'DELETE'
                });

                if (!response.ok) {
                    const data = await response.json();
                    alert(data.detail || '削除に失敗しました');
                    return;
                }

                loadRakutenProducts();
            } catch (e) {
                alert(e.message);
            }
        }

        // 人気カード更新処理
        async function handleUpdatePopular() {
            const successEl = document.getElementById('popular-success');
            successEl.textContent = '';

            try {
                const response = await Auth.authFetch('/api/admin/update-popular', {
                    method: 'POST'
                });

                const data = await response.json();
                if (!response.ok) {
                    alert(data.detail || '更新に失敗しました');
                    return;
                }

                successEl.textContent = data.message;
            } catch (e) {
                alert(e.message);
            }
        }

        // 招待コード生成処理
        async function handleGenerateInvite() {
            try {
                const response = await Auth.authFetch('/api/admin/invites', {
                    method: 'POST'
                });

                const data = await response.json();
                if (!response.ok) {
                    alert(data.detail || '生成に失敗しました');
                    return;
                }

                alert(`招待コードを生成しました: ${data.invite.code}`);
                loadInvites();
            } catch (e) {
                alert(e.message);
            }
        }

        // 招待コードをコピー
        function copyInviteCode(code) {
            navigator.clipboard.writeText(code).then(() => {
                alert('招待コードをコピーしました');
            }).catch(() => {
                prompt('招待コード:', code);
            });
        }

        // ユーティリティ
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatDate(dateStr) {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            return date.toLocaleString('ja-JP', {
                year: 'numeric',
                month: 'numeric',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
    </script>
</body>
</html>

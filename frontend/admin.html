<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
    <link rel="icon" type="image/png" sizes="32x32" href="/static/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/static/favicon-16x16.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="manifest" href="/site.webmanifest">
    <meta name="robots" content="noindex, nofollow">
    <title>ç®¡ç†ç”»é¢ | BSPrice - ãƒãƒˆã‚¹ãƒ”ä¾¡æ ¼æ¯”è¼ƒ</title>
    <link rel="stylesheet" href="/static/style.css">
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2167017279500518"
         crossorigin="anonymous"></script>
</head>
<body>
    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <header class="site-header">
        <div class="header-inner">
            <a href="/" class="site-logo">
                <div class="logo-icon">BS</div>
                <div class="logo-text-group">
                    <span class="logo-text">BSPrice</span>
                    <span class="logo-sub">ãƒãƒˆã‚¹ãƒ”ä¾¡æ ¼æ¯”è¼ƒ</span>
                </div>
            </a>
            <nav class="site-nav">
                <a href="/">ãƒˆãƒƒãƒ—</a>
                <a href="/ranking">ãƒ©ãƒ³ã‚­ãƒ³ã‚°</a>
                <a href="/shops">ã‚·ãƒ§ãƒƒãƒ—ä¸€è¦§</a>
                <a href="/blog">ãƒ–ãƒ­ã‚°</a>
            </nav>
            <div id="user-menu" class="user-menu"></div>
        </div>
    </header>

    <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
    <main class="main-content">
        <div class="container">
            <div class="search-section" style="padding-bottom: 10px;">
                <h1 class="search-title" style="font-size: 1.5rem;">ç®¡ç†è€…ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
            </div>

            <!-- TODO ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼ -->
            <div class="admin-reminder">
                <div class="reminder-icon">!</div>
                <div class="reminder-content">
                    <div class="reminder-title">TODO: æ–°å¼¾è¿½åŠ ãƒ—ãƒ­ã‚°ãƒ©ãƒ ä½œæˆ</div>
                    <div class="reminder-desc">
                        <strong>2æœˆ14æ—¥</strong>ã«æ–°å¼¾ãŒç™ºå£²äºˆå®šã€‚<br>
                        æ–°å¼¾ã®ã‚«ãƒ¼ãƒ‰ã®ã¿ã‚’è¿½åŠ ã™ã‚‹ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’ä½œæˆã™ã‚‹ã“ã¨ã€‚
                    </div>
                </div>
            </div>

            <div id="admin-content" class="admin-content hidden">
                <!-- ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
                <div class="admin-tabs">
                    <button class="admin-tab active" data-tab="dashboard">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</button>
                    <button class="admin-tab" data-tab="cards">ã‚«ãƒ¼ãƒ‰ç®¡ç†</button>
                    <button class="admin-tab" data-tab="content">ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ç®¡ç†</button>
                    <button class="admin-tab" data-tab="x-posts">XæŠ•ç¨¿</button>
                    <button class="admin-tab" data-tab="analytics">ã‚¢ã‚¯ã‚»ã‚¹è§£æ</button>
                    <button class="admin-tab" data-tab="users">ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†</button>
                    <button class="admin-tab" data-tab="articles">ãƒ–ãƒ­ã‚°è¨˜äº‹</button>
                    <button class="admin-tab" data-tab="system">ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†</button>
                </div>

                <!-- ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚¿ãƒ– -->
                <div class="admin-tab-content active" id="tab-dashboard">
                    <!-- çµ±è¨ˆæƒ…å ± -->
                    <div class="admin-section">
                        <h2>çµ±è¨ˆæƒ…å ±</h2>
                        <div class="admin-stats" id="admin-stats">
                            <div class="stat-card">
                                <div class="stat-value" id="stat-cards">-</div>
                                <div class="stat-label">ç™»éŒ²ã‚«ãƒ¼ãƒ‰</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="stat-prices">-</div>
                                <div class="stat-label">ä¾¡æ ¼ãƒ‡ãƒ¼ã‚¿</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="stat-users">-</div>
                                <div class="stat-label">ãƒ¦ãƒ¼ã‚¶ãƒ¼</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="stat-favorites">-</div>
                                <div class="stat-label">ãŠæ°—ã«å…¥ã‚Š</div>
                            </div>
                        </div>
                    </div>

                    <!-- å·¡å›çŠ¶æ³ -->
                    <div class="admin-section">
                        <h2>å·¡å›çŠ¶æ³</h2>
                        <p class="section-desc">å„ã‚·ãƒ§ãƒƒãƒ—ã®æœ€æ–°å·¡å›çŠ¶æ³ã§ã™ã€‚</p>
                        <div id="batch-status" class="batch-status-list"></div>
                    </div>

                    <!-- äººæ°—ã‚«ãƒ¼ãƒ‰æ›´æ–° -->
                    <div class="admin-section">
                        <h2>äººæ°—ã‚«ãƒ¼ãƒ‰ç®¡ç†</h2>
                        <p class="section-desc">æ¤œç´¢æ•°ã¨ã‚¯ãƒªãƒƒã‚¯æ•°ã«åŸºã¥ã„ã¦äººæ°—ã‚«ãƒ¼ãƒ‰ãƒ•ãƒ©ã‚°ã‚’è‡ªå‹•æ›´æ–°ã—ã¾ã™ã€‚</p>
                        <button class="admin-btn" onclick="handleUpdatePopular()">äººæ°—ã‚«ãƒ¼ãƒ‰ã‚’æ›´æ–°</button>
                        <div class="form-success" id="popular-success"></div>
                    </div>
                </div>

                <!-- ã‚«ãƒ¼ãƒ‰ç®¡ç†ã‚¿ãƒ– -->
                <div class="admin-tab-content" id="tab-cards">
                    <!-- ã‚«ãƒ¼ãƒ‰ç™»éŒ² -->
                    <div class="admin-section">
                        <h2>ã‚«ãƒ¼ãƒ‰ç™»éŒ²</h2>
                        <form id="card-form" class="admin-form" onsubmit="handleAddCard(event)">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="card-name">ã‚«ãƒ¼ãƒ‰åï¼ˆå¿…é ˆï¼‰</label>
                                    <input type="text" id="card-name" required minlength="2" placeholder="ä¾‹: ã‚¸ãƒ¼ã‚¯ãƒ•ãƒªãƒ¼ãƒ‰">
                                </div>
                                <div class="form-group">
                                    <label for="card-no">ã‚«ãƒ¼ãƒ‰ç•ªå·ï¼ˆä»»æ„ï¼‰</label>
                                    <input type="text" id="card-no" placeholder="ä¾‹: BT01-001">
                                </div>
                            </div>
                            <div class="form-error" id="card-error"></div>
                            <div class="form-success" id="card-success"></div>
                            <button type="submit" class="admin-btn">ã‚«ãƒ¼ãƒ‰ã‚’ç™»éŒ²</button>
                        </form>
                    </div>

                    <!-- ã‚«ãƒ¼ãƒ‰ä¸€è¦§ -->
                    <div class="admin-section">
                        <h2>ç™»éŒ²ã‚«ãƒ¼ãƒ‰ä¸€è¦§</h2>
                        <p class="section-desc">ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ã‚«ãƒ¼ãƒ‰ã®ç®¡ç†ã¨ä¾¡æ ¼å–å¾—ãŒã§ãã¾ã™ã€‚</p>
                        <div class="form-row" style="margin-bottom: 15px;">
                            <div class="form-group" style="flex: 1;">
                                <input type="text" id="card-search" placeholder="ã‚«ãƒ¼ãƒ‰åã§æ¤œç´¢..." onkeyup="handleCardSearch(event)">
                            </div>
                            <div class="form-group" style="flex: 0;">
                                <button class="admin-btn" onclick="loadCards()">æ¤œç´¢</button>
                            </div>
                        </div>
                        <div id="card-list" class="card-list"></div>
                        <div id="card-pagination" class="pagination"></div>
                    </div>

                    <!-- ã‚«ãƒ¼ãƒ‰çµ±åˆ -->
                    <div class="admin-section">
                        <h2>ã‚«ãƒ¼ãƒ‰çµ±åˆï¼ˆåå¯„ã›ï¼‰</h2>
                        <p class="section-desc">
                            ç•°ãªã‚‹ã‚·ãƒ§ãƒƒãƒ—ã§åˆ¥åã«ãªã£ã¦ã„ã‚‹ã‚«ãƒ¼ãƒ‰ã‚’æ‰‹å‹•ã§ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã—ã¾ã™ã€‚<br>
                            åŒã˜ã‚°ãƒ«ãƒ¼ãƒ—ã®ã‚«ãƒ¼ãƒ‰ã¯è©³ç´°ãƒšãƒ¼ã‚¸ã§ä¾¡æ ¼ãŒçµ±åˆè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
                        </p>

                        <!-- ã‚°ãƒ«ãƒ¼ãƒ—ä½œæˆ -->
                        <div class="card-group-create">
                            <h3>æ–°è¦ã‚°ãƒ«ãƒ¼ãƒ—ä½œæˆ</h3>
                            <div class="form-row">
                                <div class="form-group" style="flex: 2;">
                                    <label>ã‚«ãƒ¼ãƒ‰æ¤œç´¢</label>
                                    <input type="text" id="group-card-search" placeholder="çµ±åˆã—ãŸã„ã‚«ãƒ¼ãƒ‰åã‚’æ¤œç´¢..." onkeyup="handleGroupCardSearch(event)">
                                </div>
                                <div class="form-group" style="flex: 1;">
                                    <label>ã‚°ãƒ«ãƒ¼ãƒ—å</label>
                                    <input type="text" id="group-name" placeholder="ä¾‹: ã‚¸ãƒ¼ã‚¯ãƒ•ãƒªãƒ¼ãƒ‰">
                                </div>
                            </div>

                            <!-- æ¤œç´¢çµæœ -->
                            <div id="group-search-results" class="group-search-results"></div>

                            <!-- é¸æŠæ¸ˆã¿ã‚«ãƒ¼ãƒ‰ -->
                            <div id="group-selected-cards" class="group-selected-cards">
                                <h4>çµ±åˆã™ã‚‹ã‚«ãƒ¼ãƒ‰ï¼ˆ<span id="selected-count">0</span>ä»¶é¸æŠä¸­ï¼‰</h4>
                                <div id="selected-cards-list"></div>
                            </div>

                            <button class="admin-btn" onclick="handleCreateGroup()" id="create-group-btn" disabled>ã‚°ãƒ«ãƒ¼ãƒ—ã‚’ä½œæˆ</button>
                            <div class="form-error" id="group-error"></div>
                            <div class="form-success" id="group-success"></div>
                        </div>

                        <!-- æ—¢å­˜ã‚°ãƒ«ãƒ¼ãƒ—ä¸€è¦§ -->
                        <div class="card-group-list">
                            <h3>æ—¢å­˜ã‚°ãƒ«ãƒ¼ãƒ—ä¸€è¦§</h3>
                            <button class="admin-btn admin-btn-secondary" onclick="loadCardGroups()">æ›´æ–°</button>
                            <div id="card-groups-list"></div>
                        </div>
                    </div>
                </div>

                <!-- ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ç®¡ç†ã‚¿ãƒ– -->
                <div class="admin-tab-content" id="tab-content">
                    <!-- äººæ°—ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ç®¡ç† -->
                    <div class="admin-section">
                        <h2>äººæ°—ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ç®¡ç†</h2>
                        <p class="section-desc">ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã«è¡¨ç¤ºã•ã‚Œã‚‹æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’ç®¡ç†ã—ã¾ã™ã€‚ä¾¡æ ¼ã¯1æ—¥2å›è‡ªå‹•æ›´æ–°ã•ã‚Œã¾ã™ã€‚</p>
                        <form id="keyword-form" class="admin-form" onsubmit="handleAddKeyword(event)">
                            <div class="form-row">
                                <div class="form-group" style="flex: 1;">
                                    <label for="new-keyword">ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰è¿½åŠ </label>
                                    <input type="text" id="new-keyword" required placeholder="ä¾‹: ã‚¸ãƒ¼ã‚¯ãƒ•ãƒªãƒ¼ãƒ‰">
                                </div>
                                <div class="form-group" style="flex: 0; padding-top: 24px;">
                                    <button type="submit" class="admin-btn">è¿½åŠ </button>
                                </div>
                            </div>
                            <div class="form-error" id="keyword-error"></div>
                        </form>
                        <div style="margin: 15px 0;">
                            <button class="admin-btn" onclick="updateAllKeywordPrices()" id="update-all-btn">å…¨ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®ä¾¡æ ¼ã‚’æ›´æ–°</button>
                            <span id="update-all-status" style="margin-left: 10px; color: #666;"></span>
                        </div>
                        <div class="keyword-list" id="keyword-list"></div>
                    </div>

                    <!-- Amazonå•†å“ç®¡ç† -->
                    <div class="admin-section">
                        <h2>Amazonå•†å“ç®¡ç†</h2>
                        <p class="section-desc">æ¤œç´¢çµæœã«è¡¨ç¤ºã™ã‚‹Amazonå•†å“ã‚’ç®¡ç†ã—ã¾ã™ã€‚</p>
                        <form id="amazon-form" class="admin-form" onsubmit="handleAddAmazonProduct(event)">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="amazon-url">Amazon URL</label>
                                    <input type="url" id="amazon-url" required placeholder="https://www.amazon.co.jp/dp/...">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="amazon-name">å•†å“å</label>
                                    <input type="text" id="amazon-name" required placeholder="å•†å“åã‚’å…¥åŠ›">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="amazon-price">ä¾¡æ ¼ï¼ˆç¨è¾¼ï¼‰</label>
                                    <input type="number" id="amazon-price" required placeholder="5390">
                                </div>
                                <div class="form-group">
                                    <label for="amazon-image">ç”»åƒURL</label>
                                    <input type="url" id="amazon-image" required placeholder="https://m.media-amazon.com/...">
                                </div>
                            </div>
                            <div class="form-error" id="amazon-error"></div>
                            <div class="form-success" id="amazon-success"></div>
                            <button type="submit" class="admin-btn">å•†å“ã‚’è¿½åŠ </button>
                        </form>
                        <div class="amazon-product-list" id="amazon-product-list"></div>
                    </div>

                    <!-- æ¥½å¤©å•†å“ç®¡ç† -->
                    <div class="admin-section">
                        <h2>æ¥½å¤©å•†å“ç®¡ç†</h2>
                        <p class="section-desc">æ¤œç´¢çµæœã«è¡¨ç¤ºã™ã‚‹æ¥½å¤©å•†å“ã‚’ç®¡ç†ã—ã¾ã™ã€‚</p>
                        <form id="rakuten-form" class="admin-form" onsubmit="handleAddRakutenProduct(event)">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="rakuten-url">æ¥½å¤©ã‚¢ãƒ•ã‚£ãƒªã‚¨ã‚¤ãƒˆURL</label>
                                    <input type="url" id="rakuten-url" required placeholder="https://hb.afl.rakuten.co.jp/...">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="rakuten-name">å•†å“å</label>
                                    <input type="text" id="rakuten-name" required placeholder="å•†å“åã‚’å…¥åŠ›">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="rakuten-price">ä¾¡æ ¼ï¼ˆç¨è¾¼ï¼‰</label>
                                    <input type="number" id="rakuten-price" required placeholder="5040">
                                </div>
                                <div class="form-group">
                                    <label for="rakuten-image">ç”»åƒURL</label>
                                    <input type="url" id="rakuten-image" required placeholder="https://...">
                                </div>
                            </div>
                            <div class="form-error" id="rakuten-error"></div>
                            <div class="form-success" id="rakuten-success"></div>
                            <button type="submit" class="admin-btn">å•†å“ã‚’è¿½åŠ </button>
                        </form>
                        <div class="rakuten-product-list" id="rakuten-product-list"></div>
                    </div>
                </div>

                <!-- XæŠ•ç¨¿ã‚¿ãƒ– -->
                <div class="admin-tab-content" id="tab-x-posts">
                    <!-- ã‚«ã‚¹ã‚¿ãƒ æŠ•ç¨¿ä½œæˆ -->
                    <div class="admin-section">
                        <h2>ã‚«ã‚¹ã‚¿ãƒ æŠ•ç¨¿ã‚’ä½œæˆ</h2>
                        <div class="custom-post-form">
                            <textarea id="custom-post-content" placeholder="æŠ•ç¨¿å†…å®¹ã‚’å…¥åŠ›..." rows="4" style="width: 100%; padding: 10px; background: var(--background-secondary); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); font-size: 0.95rem; resize: vertical;"></textarea>
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px;">
                                <span id="custom-post-count" style="color: var(--text-secondary); font-size: 0.85rem;">0 / 280æ–‡å­—</span>
                                <div>
                                    <button class="admin-btn admin-btn-secondary" onclick="previewCustomPost()" style="margin-right: 10px;">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</button>
                                    <button class="admin-btn admin-btn-primary" onclick="createCustomPost()">ã‚­ãƒ¥ãƒ¼ã«è¿½åŠ </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- æŠ•ç¨¿ã‚­ãƒ¥ãƒ¼ä¸€è¦§ -->
                    <div class="admin-section">
                        <h2>XæŠ•ç¨¿ã‚­ãƒ¥ãƒ¼</h2>
                        <p class="section-desc">
                            ä¾¡æ ¼å¤‰å‹•æ™‚ã«è‡ªå‹•ç”Ÿæˆã•ã‚ŒãŸæŠ•ç¨¿æ–‡ã€ã¾ãŸã¯ã‚«ã‚¹ã‚¿ãƒ æŠ•ç¨¿ã§ã™ã€‚<br>
                            ã€ŒXã§æŠ•ç¨¿ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã€Xã®æŠ•ç¨¿ç”»é¢ãŒé–‹ãã¾ã™ã€‚
                        </p>
                        <div class="x-posts-controls" style="margin-bottom: 15px;">
                            <label>
                                <input type="checkbox" id="x-posts-pending-only" onchange="loadXPosts()">
                                æœªæŠ•ç¨¿ã®ã¿è¡¨ç¤º
                            </label>
                            <button class="admin-btn admin-btn-small" onclick="loadXPosts()" style="margin-left: 15px;">æ›´æ–°</button>
                        </div>
                        <div id="x-posts-list" class="x-posts-list"></div>
                    </div>
                </div>

                <!-- ã‚¢ã‚¯ã‚»ã‚¹è§£æã‚¿ãƒ– -->
                <div class="admin-tab-content" id="tab-analytics">
                    <!-- ã‚¢ã‚¯ã‚»ã‚¹æ¨ç§»ï¼ˆæ¤œç´¢ãƒ»ã‚¯ãƒªãƒƒã‚¯çµ±åˆï¼‰ -->
                    <div class="admin-section">
                        <h2>ã‚¢ã‚¯ã‚»ã‚¹æ¨ç§»</h2>
                        <div class="analytics-controls" style="margin-bottom: 20px;">
                            <div class="form-group" style="display: inline-block; margin-right: 15px;">
                                <label for="analytics-period">æœŸé–“:</label>
                                <select id="analytics-period" onchange="loadAnalytics()">
                                    <option value="daily">æ—¥åˆ¥</option>
                                    <option value="weekly">é€±åˆ¥</option>
                                    <option value="monthly">æœˆåˆ¥</option>
                                </select>
                            </div>
                            <div class="form-group" style="display: inline-block;">
                                <label for="analytics-days">æ—¥æ•°:</label>
                                <select id="analytics-days" onchange="loadAnalytics()">
                                    <option value="7" selected>éå»7æ—¥</option>
                                    <option value="30">éå»30æ—¥</option>
                                    <option value="90">éå»90æ—¥</option>
                                </select>
                            </div>
                        </div>
                        <h4 style="margin: 20px 0 10px; color: var(--text-secondary);">æ¤œç´¢æ•°</h4>
                        <div id="search-stats-chart" class="analytics-chart"></div>
                        <h4 style="margin: 30px 0 10px; color: var(--text-secondary);">ã‚¯ãƒªãƒƒã‚¯æ•°</h4>
                        <div id="click-stats-chart" class="analytics-chart"></div>
                    </div>

                    <!-- äººæ°—ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒ©ãƒ³ã‚­ãƒ³ã‚° -->
                    <div class="admin-section">
                        <h3>äººæ°—æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ TOP20</h3>
                        <div id="keyword-ranking" class="ranking-list"></div>
                    </div>

                    <!-- ã‚·ãƒ§ãƒƒãƒ—åˆ¥ã‚¯ãƒªãƒƒã‚¯æ•° -->
                    <div class="admin-section">
                        <h3>ã‚·ãƒ§ãƒƒãƒ—åˆ¥ã‚¯ãƒªãƒƒã‚¯æ•°</h3>
                        <div id="shop-ranking" class="ranking-list"></div>
                    </div>

                    <!-- äººæ°—ã‚«ãƒ¼ãƒ‰ãƒ©ãƒ³ã‚­ãƒ³ã‚° -->
                    <div class="admin-section">
                        <h3>äººæ°—ã‚«ãƒ¼ãƒ‰ãƒ©ãƒ³ã‚­ãƒ³ã‚° TOP20</h3>
                        <div id="card-ranking" class="ranking-list"></div>
                    </div>
                </div>

                <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ã‚¿ãƒ– -->
                <div class="admin-tab-content" id="tab-users">
                    <div class="admin-section">
                        <h2>ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†</h2>
                        <div class="form-row" style="margin-bottom: 15px;">
                            <div class="form-group" style="flex: 1;">
                                <input type="text" id="user-search" placeholder="ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¾ãŸã¯ãƒ¡ãƒ¼ãƒ«ã§æ¤œç´¢..." onkeyup="handleUserSearch(event)">
                            </div>
                            <div class="form-group" style="flex: 0;">
                                <button class="admin-btn" onclick="loadUsers()">æ¤œç´¢</button>
                            </div>
                        </div>
                        <div id="user-list" class="user-list"></div>
                        <div id="user-pagination" class="pagination"></div>
                    </div>
                </div>

                <!-- ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†ã‚¿ãƒ– -->
                <div class="admin-tab-content" id="tab-articles">
                    <div class="admin-section">
                        <h2 id="article-form-title">æ–°ã—ã„è¨˜äº‹ã‚’ä½œæˆ</h2>
                        <div class="article-editor">
                            <input type="hidden" id="article-edit-id" value="">
                            <div class="form-row">
                                <label>ã‚¿ã‚¤ãƒˆãƒ«</label>
                                <input type="text" id="article-title" placeholder="è¨˜äº‹ã®ã‚¿ã‚¤ãƒˆãƒ«" oninput="generateSlugFromTitle()">
                            </div>
                            <div class="form-row">
                                <label>ã‚¹ãƒ©ãƒƒã‚°ï¼ˆURLï¼‰</label>
                                <div class="slug-preview">
                                    <span class="slug-prefix">/blog/</span>
                                    <input type="text" id="article-slug" placeholder="url-friendly-slug">
                                </div>
                            </div>
                            <div class="form-row">
                                <label>æ¦‚è¦</label>
                                <textarea id="article-description" rows="2" placeholder="è¨˜äº‹ã®æ¦‚è¦ï¼ˆä¸€è¦§ã‚„ãƒ¡ã‚¿ã‚¿ã‚°ã«ä½¿ç”¨ï¼‰"></textarea>
                            </div>
                            <div class="form-row">
                                <label>ã‚µãƒ ãƒã‚¤ãƒ«</label>
                                <div class="thumbnail-row">
                                    <input type="text" id="article-thumbnail" placeholder="URLã¾ãŸã¯ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰">
                                    <button class="toolbar-btn" onclick="document.getElementById('thumbnail-file-input').click();" type="button">ğŸ“·</button>
                                    <input type="file" id="thumbnail-file-input" accept="image/*" capture="environment" style="display:none;" onchange="uploadThumbnailImage(this.files[0])">
                                </div>
                            </div>
                            <div class="form-row">
                                <label>æœ¬æ–‡</label>
                                <div class="editor-toolbar">
                                    <button class="toolbar-btn" onclick="document.getElementById('content-image-input').click();" type="button">ğŸ“· ç”»åƒ</button>
                                    <button class="toolbar-btn" id="toggle-markdown-btn" onclick="toggleMarkdownView()" type="button">MD</button>
                                    <input type="file" id="content-image-input" accept="image/*" capture="environment" style="display:none;" onchange="handleContentImageSelect(this.files[0])">
                                </div>
                                <textarea id="article-content" class="hidden" rows="12" oninput="syncTextareaToEditor()"></textarea>
                                <div id="wysiwyg-editor" class="wysiwyg-editor" contenteditable="true"
                                    oninput="syncEditorToTextarea()"
                                    ondragover="event.preventDefault();this.classList.add('drag-over');"
                                    ondragleave="this.classList.remove('drag-over');"
                                    ondrop="handleEditorImageDrop(event);this.classList.remove('drag-over');"
                                    data-placeholder="ã“ã“ã«è¨˜äº‹ã‚’æ›¸ã„ã¦ãã ã•ã„..."></div>
                            </div>
                            <div class="form-row">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="article-published"> å…¬é–‹ã™ã‚‹
                                </label>
                            </div>
                            <div class="form-actions article-form-actions">
                                <button class="admin-btn" id="article-submit-btn" onclick="handleSubmitArticle()">ä½œæˆ</button>
                                <button class="admin-btn admin-btn-outline" onclick="handleSaveDraft()">ä¸‹æ›¸ãä¿å­˜</button>
                                <button class="admin-btn admin-btn-secondary" id="article-cancel-btn" onclick="cancelEditArticle()" style="display:none;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                                <span id="autosave-status" class="autosave-status"></span>
                            </div>
                        </div>
                    </div>

                    <div class="admin-section">
                        <h2>è¨˜äº‹ä¸€è¦§</h2>
                        <div id="article-list-admin" class="admin-article-list"></div>
                    </div>
                </div>

                <div class="admin-tab-content" id="tab-system">
                    <!-- æ‹›å¾…ã‚³ãƒ¼ãƒ‰ç®¡ç† -->
                    <div class="admin-section">
                        <h2>ç®¡ç†è€…æ‹›å¾…ã‚³ãƒ¼ãƒ‰</h2>
                        <p class="section-desc">æ–°ã—ã„ç®¡ç†è€…ã‚’æ‹›å¾…ã™ã‚‹ãŸã‚ã®ã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆã—ã¾ã™ã€‚</p>
                        <button class="admin-btn" onclick="handleGenerateInvite()">æ–°ã—ã„æ‹›å¾…ã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆ</button>
                        <div class="invite-list" id="invite-list"></div>
                    </div>
                </div>
            </div>

            <div id="loading" class="loading">
                <div class="spinner"></div>
                <p>èª­ã¿è¾¼ã¿ä¸­...</p>
            </div>

            <div id="not-admin" class="not-admin hidden">
                <p>ç®¡ç†è€…æ¨©é™ãŒå¿…è¦ã§ã™ã€‚</p>
                <a href="/" class="back-link">ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹</a>
            </div>
        </div>
    </main>

    <!-- ãƒ•ãƒƒã‚¿ãƒ¼ -->
    <footer class="site-footer">
        <div class="footer-inner">
            <div class="footer-links">
                <div class="footer-section">
                    <h4>ãƒšãƒ¼ã‚¸</h4>
                    <a href="/">ãƒˆãƒƒãƒ—</a>
                    <a href="/ranking">ãƒ©ãƒ³ã‚­ãƒ³ã‚°</a>
                    <a href="/shops">ã‚·ãƒ§ãƒƒãƒ—ä¸€è¦§</a>
                    <a href="/blog">ãƒ–ãƒ­ã‚°</a>
                </div>
                <div class="footer-section">
                    <h4>å¯¾å¿œã‚·ãƒ§ãƒƒãƒ—</h4>
                    <span>ã‚«ãƒ¼ãƒ‰ãƒ©ãƒƒã‚·ãƒ¥</span>
                    <span>Tier One</span>
                    <span>ãƒ•ãƒ«ã‚¢ãƒ˜ãƒƒãƒ‰</span>
                    <span>ãƒ›ãƒ“ãƒ¼ã‚¹ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³</span>
                    <span>ãƒãƒˆã‚¹ã‚­</span>
                    <span>éŠã€…äº­</span>
                </div>
                <div class="footer-section">
                    <h4>ãã®ä»–</h4>
                    <a href="/login">ãƒ­ã‚°ã‚¤ãƒ³</a>
                    <a href="/about">ã“ã®ã‚µã‚¤ãƒˆã«ã¤ã„ã¦</a>
                    <a href="/privacy">ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼</a>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2026 BSPrice - ãƒãƒˆã‚¹ãƒ”ä¾¡æ ¼æ¯”è¼ƒ</p>
                <p class="footer-note">â€»ä¾¡æ ¼ã¯å„ã‚·ãƒ§ãƒƒãƒ—ã®åœ¨åº«çŠ¶æ³ã«ã‚ˆã‚Šå¤‰å‹•ã—ã¾ã™</p>
            </div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3/dist/purify.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/turndown@7/dist/turndown.js"></script>
    <script src="/static/auth.js"></script>
    <script>
        // ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±
        let currentAdmin = null;

        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', async () => {
            const loadingEl = document.getElementById('loading');
            const contentEl = document.getElementById('admin-content');
            const notAdminEl = document.getElementById('not-admin');

            // ãƒ­ã‚°ã‚¤ãƒ³ãƒã‚§ãƒƒã‚¯
            if (!Auth.isLoggedIn()) {
                window.location.href = '/login';
                return;
            }

            // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—
            const user = await Auth.fetchCurrentUser();
            if (!user || user.role !== 'admin') {
                loadingEl.classList.add('hidden');
                notAdminEl.classList.remove('hidden');
                return;
            }

            currentAdmin = user;

            // ç®¡ç†è€…ãªã®ã§ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’è¡¨ç¤º
            loadingEl.classList.add('hidden');
            contentEl.classList.remove('hidden');

            // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š
            setupTabs();

            // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
            loadStats();
            loadBatchStatus();
            loadInvites();
            loadKeywords();
            loadCards();
            loadAmazonProducts();
            loadRakutenProducts();
            loadAnalytics();
            loadCardGroups();
            loadAdminArticles();
            updateSelectedCardsDisplay();
            loadUsers();
            restoreLocalDraft();
        });

        // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆè¨­å®š
        function setupTabs() {
            const tabs = document.querySelectorAll('.admin-tab');
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    // ã‚¿ãƒ–ãƒœã‚¿ãƒ³ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã‚’åˆ‡ã‚Šæ›¿ãˆ
                    tabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');

                    // ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®è¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆ
                    const tabId = tab.dataset.tab;
                    document.querySelectorAll('.admin-tab-content').forEach(content => {
                        content.classList.remove('active');
                    });
                    document.getElementById(`tab-${tabId}`).classList.add('active');
                });
            });
        }

        // çµ±è¨ˆæƒ…å ±ã‚’èª­ã¿è¾¼ã¿
        async function loadStats() {
            try {
                const response = await Auth.authFetch('/api/admin/stats');
                if (!response.ok) return;
                const data = await response.json();
                const stats = data.stats;

                document.getElementById('stat-cards').textContent = (stats.cards || 0).toLocaleString();
                document.getElementById('stat-prices').textContent = (stats.prices || 0).toLocaleString();
                document.getElementById('stat-users').textContent = (stats.users || 0).toLocaleString();
                document.getElementById('stat-favorites').textContent = (stats.favorites || 0).toLocaleString();
            } catch (e) {
                console.error('Failed to load stats:', e);
            }
        }

        // å·¡å›çŠ¶æ³ã‚’èª­ã¿è¾¼ã¿
        async function loadBatchStatus() {
            try {
                const response = await fetch('/api/home');
                if (!response.ok) return;
                const data = await response.json();
                renderBatchStatus(data.batch_logs);
            } catch (e) {
                console.error('Failed to load batch status:', e);
            }
        }

        // å·¡å›çŠ¶æ³ã‚’æç”»
        function renderBatchStatus(batchLogs) {
            const container = document.getElementById('batch-status');
            if (!container) return;

            if (!batchLogs || batchLogs.length === 0) {
                container.innerHTML = '<p class="no-data">å·¡å›ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                return;
            }

            // 48æ™‚é–“ä»¥å†…ã®ãƒ­ã‚°ã®ã¿
            const now = new Date();
            const recentLogs = batchLogs.filter(log => {
                const logDate = new Date(log.finished_at);
                const diffHours = (now - logDate) / (1000 * 60 * 60);
                return diffHours < 48;
            });

            if (recentLogs.length === 0) {
                container.innerHTML = '<p class="no-data">48æ™‚é–“ä»¥å†…ã®å·¡å›ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                return;
            }

            // å„ã‚·ãƒ§ãƒƒãƒ—ã®æœ€æ–°ãƒ­ã‚°ã‚’å–å¾—
            const shopLogs = {};
            recentLogs.forEach(log => {
                if (!shopLogs[log.shop_name]) {
                    shopLogs[log.shop_name] = log;
                }
            });

            container.innerHTML = Object.values(shopLogs).map(log => `
                <div class="batch-status-item ${log.status === 'success' ? 'success' : 'error'}">
                    <div class="batch-shop-name">${escapeHtml(log.shop_name)}</div>
                    <div class="batch-shop-stats">
                        <span class="batch-stat">${log.cards_total.toLocaleString()}ä»¶å–å¾—</span>
                        <span class="batch-stat">${log.cards_new.toLocaleString()}ä»¶æ–°è¦</span>
                        <span class="batch-stat">${(log.cards_updated || 0).toLocaleString()}ä»¶æ›´æ–°</span>
                        <span class="batch-time">${formatDateJST(log.finished_at)}</span>
                    </div>
                    <div class="batch-status-badge ${log.status}">${log.status === 'success' ? 'æˆåŠŸ' : 'ã‚¨ãƒ©ãƒ¼'}</div>
                </div>
            `).join('');
        }

        // JSTæ—¥ä»˜ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼ˆUTCã¨ã—ã¦è§£é‡ˆã—ã¦JSTã«å¤‰æ›ï¼‰
        function formatDateJST(dateStr) {
            if (!dateStr) return '';
            // UTCã¨ã—ã¦è§£é‡ˆã™ã‚‹ãŸã‚ã«Zã‚’è¿½åŠ ï¼ˆæ—¢ã«ã‚ã‚‹å ´åˆã¯è¿½åŠ ã—ãªã„ï¼‰
            let utcStr = dateStr;
            if (!dateStr.endsWith('Z') && !dateStr.includes('+')) {
                utcStr = dateStr.replace(' ', 'T') + 'Z';
            }
            const date = new Date(utcStr);
            return date.toLocaleString('ja-JP', {
                timeZone: 'Asia/Tokyo',
                month: 'numeric',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // æ‹›å¾…ã‚³ãƒ¼ãƒ‰ä¸€è¦§ã‚’èª­ã¿è¾¼ã¿
        async function loadInvites() {
            try {
                const response = await Auth.authFetch('/api/admin/invites');
                if (!response.ok) return;
                const data = await response.json();
                renderInvites(data.invites);
            } catch (e) {
                console.error('Failed to load invites:', e);
            }
        }

        // æ‹›å¾…ã‚³ãƒ¼ãƒ‰ä¸€è¦§ã‚’æç”»
        function renderInvites(invites) {
            const listEl = document.getElementById('invite-list');
            if (!invites || invites.length === 0) {
                listEl.innerHTML = '<p class="no-data">æ‹›å¾…ã‚³ãƒ¼ãƒ‰ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                return;
            }

            listEl.innerHTML = invites.map(invite => `
                <div class="invite-item ${invite.is_used ? 'used' : ''}">
                    <div class="invite-code">${escapeHtml(invite.code)}</div>
                    <div class="invite-status">
                        ${invite.is_used
                            ? `<span class="status-used">ä½¿ç”¨æ¸ˆã¿</span>`
                            : `<span class="status-unused">æœªä½¿ç”¨</span><button class="copy-btn" onclick="copyInviteCode('${invite.code}')">ã‚³ãƒ”ãƒ¼</button>`
                        }
                    </div>
                    <div class="invite-date">${formatDate(invite.created_at)}</div>
                </div>
            `).join('');
        }

        // ã‚«ãƒ¼ãƒ‰ç™»éŒ²å‡¦ç†
        async function handleAddCard(event) {
            event.preventDefault();
            const errorEl = document.getElementById('card-error');
            const successEl = document.getElementById('card-success');
            errorEl.textContent = '';
            successEl.textContent = '';

            const name = document.getElementById('card-name').value;
            const cardNo = document.getElementById('card-no').value;

            try {
                const response = await Auth.authFetch('/api/admin/cards', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, card_no: cardNo || null })
                });

                const data = await response.json();
                if (!response.ok) {
                    errorEl.textContent = data.detail || 'ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ';
                    return;
                }

                successEl.textContent = `ã€Œ${name}ã€ã‚’ç™»éŒ²ã—ã¾ã—ãŸ`;
                document.getElementById('card-name').value = '';
                document.getElementById('card-no').value = '';
                loadStats();
                loadCards();
            } catch (e) {
                errorEl.textContent = e.message;
            }
        }

        // =================================================================
        // ã‚«ãƒ¼ãƒ‰ä¸€è¦§ç®¡ç†
        // =================================================================

        let cardCurrentPage = 0;
        const cardPageSize = 20;

        async function loadCards(page = 0) {
            cardCurrentPage = page;
            const search = document.getElementById('card-search').value.trim();
            const offset = page * cardPageSize;

            try {
                const params = new URLSearchParams({
                    limit: cardPageSize,
                    offset: offset
                });
                if (search) params.append('search', search);

                const response = await Auth.authFetch(`/api/admin/cards?${params}`);
                if (!response.ok) return;
                const data = await response.json();
                renderCards(data.cards, data.total);
            } catch (e) {
                console.error('Failed to load cards:', e);
            }
        }

        function handleCardSearch(event) {
            if (event.key === 'Enter') {
                loadCards(0);
            }
        }

        function renderCards(cards, total) {
            const listEl = document.getElementById('card-list');
            const paginationEl = document.getElementById('card-pagination');

            if (!cards || cards.length === 0) {
                listEl.innerHTML = '<p class="no-data">ã‚«ãƒ¼ãƒ‰ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                paginationEl.innerHTML = '';
                return;
            }

            listEl.innerHTML = `
                <div class="card-list-header">
                    <span class="card-col-id">ID</span>
                    <span class="card-col-name">ã‚«ãƒ¼ãƒ‰å</span>
                    <span class="card-col-no">ç•ªå·</span>
                    <span class="card-col-prices">ä¾¡æ ¼æ•°</span>
                    <span class="card-col-updated">æœ€çµ‚å–å¾—</span>
                    <span class="card-col-actions">æ“ä½œ</span>
                </div>
                ${cards.map(card => `
                    <div class="card-list-item" data-id="${card.id}">
                        <span class="card-col-id">${card.id}</span>
                        <span class="card-col-name">${escapeHtml(card.name)}</span>
                        <span class="card-col-no">${card.card_no || '-'}</span>
                        <span class="card-col-prices">${card.price_count || 0}</span>
                        <span class="card-col-updated">${card.last_price_fetch_at ? formatDate(card.last_price_fetch_at) : 'æœªå–å¾—'}</span>
                        <span class="card-col-actions">
                            <button class="card-btn fetch-btn" onclick="fetchCardPrices(${card.id}, '${escapeHtml(card.name)}')" title="ä¾¡æ ¼ã‚’å–å¾—">ä¾¡æ ¼å–å¾—</button>
                            <button class="card-btn delete-btn" onclick="deleteCard(${card.id}, '${escapeHtml(card.name)}')" title="å‰Šé™¤">Ã—</button>
                        </span>
                    </div>
                `).join('')}
            `;

            const totalPages = Math.ceil(total / cardPageSize);
            if (totalPages <= 1) {
                paginationEl.innerHTML = `<span class="page-info">${total}ä»¶</span>`;
                return;
            }

            let paginationHtml = `<span class="page-info">${total}ä»¶ä¸­ ${cardCurrentPage * cardPageSize + 1}-${Math.min((cardCurrentPage + 1) * cardPageSize, total)}ä»¶</span>`;

            if (cardCurrentPage > 0) {
                paginationHtml += `<button class="page-btn" onclick="loadCards(${cardCurrentPage - 1})">å‰ã¸</button>`;
            }

            paginationHtml += `<span class="page-current">${cardCurrentPage + 1} / ${totalPages}</span>`;

            if (cardCurrentPage < totalPages - 1) {
                paginationHtml += `<button class="page-btn" onclick="loadCards(${cardCurrentPage + 1})">æ¬¡ã¸</button>`;
            }

            paginationEl.innerHTML = paginationHtml;
        }

        async function fetchCardPrices(cardId, cardName) {
            if (!confirm(`ã€Œ${cardName}ã€ã®ä¾¡æ ¼ã‚’å„ã‚·ãƒ§ãƒƒãƒ—ã‹ã‚‰å–å¾—ã—ã¾ã™ã€‚\næ•°åç§’ã‹ã‹ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚ç¶šè¡Œã—ã¾ã™ã‹ï¼Ÿ`)) return;

            const btn = event.target;
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = 'å–å¾—ä¸­...';

            try {
                const response = await Auth.authFetch(`/api/admin/cards/${cardId}/fetch-prices`, {
                    method: 'POST'
                });

                const data = await response.json();
                if (!response.ok) {
                    alert(data.detail || 'ä¾¡æ ¼å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
                    return;
                }

                let resultMsg = `ã€Œ${cardName}ã€ã®ä¾¡æ ¼å–å¾—å®Œäº†\n\n`;
                resultMsg += `å–å¾—: ${data.stats.total}ä»¶\n`;
                resultMsg += `æ›´æ–°: ${data.stats.new}ä»¶\n\n`;
                if (data.stats.shops) {
                    resultMsg += `ã€ã‚·ãƒ§ãƒƒãƒ—åˆ¥ã€‘\n`;
                    for (const [shop, stat] of Object.entries(data.stats.shops)) {
                        resultMsg += `${shop}: ${stat.found}ä»¶å–å¾—, ${stat.saved}ä»¶æ›´æ–°\n`;
                    }
                }
                alert(resultMsg);

                loadCards(cardCurrentPage);
                loadStats();
            } catch (e) {
                alert(e.message);
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
            }
        }

        async function deleteCard(cardId, cardName) {
            if (!confirm(`ã€Œ${cardName}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\né–¢é€£ã™ã‚‹ä¾¡æ ¼ãƒ‡ãƒ¼ã‚¿ã‚‚å…¨ã¦å‰Šé™¤ã•ã‚Œã¾ã™ã€‚`)) return;

            try {
                const response = await Auth.authFetch(`/api/admin/cards/${cardId}`, {
                    method: 'DELETE'
                });

                const data = await response.json();
                if (!response.ok) {
                    alert(data.detail || 'å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
                    return;
                }

                alert(data.message);
                loadCards(cardCurrentPage);
                loadStats();
            } catch (e) {
                alert(e.message);
            }
        }

        // =================================================================
        // äººæ°—ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ç®¡ç†
        // =================================================================

        async function loadKeywords() {
            try {
                const response = await Auth.authFetch('/api/admin/featured-keywords');
                if (!response.ok) return;
                const data = await response.json();
                renderKeywords(data.keywords);
            } catch (e) {
                console.error('Failed to load keywords:', e);
            }
        }

        function renderKeywords(keywords) {
            const listEl = document.getElementById('keyword-list');
            if (!keywords || keywords.length === 0) {
                listEl.innerHTML = '<p class="no-data">ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                return;
            }

            listEl.innerHTML = keywords.map((kw, index) => `
                <div class="keyword-item ${kw.is_active ? '' : 'inactive'}" data-id="${kw.id}">
                    <span class="keyword-order">${index + 1}</span>
                    <span class="keyword-text">${escapeHtml(kw.keyword)}</span>
                    <div class="keyword-actions">
                        <button class="keyword-btn update-price-btn" onclick="updateKeywordPrices(${kw.id}, '${escapeHtml(kw.keyword)}')" title="ä¾¡æ ¼ã‚’å³åº§ã«æ›´æ–°">ä¾¡æ ¼æ›´æ–°</button>
                        <button class="keyword-btn toggle-btn" onclick="toggleKeyword(${kw.id}, ${kw.is_active})" title="${kw.is_active ? 'éè¡¨ç¤ºã«ã™ã‚‹' : 'è¡¨ç¤ºã™ã‚‹'}">
                            ${kw.is_active ? 'è¡¨ç¤ºä¸­' : 'éè¡¨ç¤º'}
                        </button>
                        <button class="keyword-btn move-btn" onclick="moveKeyword(${kw.id}, -1)" title="ä¸Šã«ç§»å‹•" ${index === 0 ? 'disabled' : ''}>â†‘</button>
                        <button class="keyword-btn move-btn" onclick="moveKeyword(${kw.id}, 1)" title="ä¸‹ã«ç§»å‹•" ${index === keywords.length - 1 ? 'disabled' : ''}>â†“</button>
                        <button class="keyword-btn delete-btn" onclick="deleteKeyword(${kw.id})" title="å‰Šé™¤">Ã—</button>
                    </div>
                </div>
            `).join('');
        }

        async function handleAddKeyword(event) {
            event.preventDefault();
            const errorEl = document.getElementById('keyword-error');
            errorEl.textContent = '';

            const keyword = document.getElementById('new-keyword').value.trim();
            if (!keyword) return;

            try {
                const response = await Auth.authFetch('/api/admin/featured-keywords', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ keyword })
                });

                const data = await response.json();
                if (!response.ok) {
                    errorEl.textContent = data.detail || 'è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ';
                    return;
                }

                document.getElementById('new-keyword').value = '';
                loadKeywords();
            } catch (e) {
                errorEl.textContent = e.message;
            }
        }

        async function toggleKeyword(id, currentActive) {
            try {
                const response = await Auth.authFetch(`/api/admin/featured-keywords/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ is_active: currentActive ? 0 : 1 })
                });

                if (!response.ok) {
                    const data = await response.json();
                    alert(data.detail || 'æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ');
                    return;
                }

                loadKeywords();
            } catch (e) {
                alert(e.message);
            }
        }

        let currentKeywords = [];
        async function moveKeyword(id, direction) {
            const response = await Auth.authFetch('/api/admin/featured-keywords');
            if (!response.ok) return;
            const data = await response.json();
            currentKeywords = data.keywords;

            const index = currentKeywords.findIndex(k => k.id === id);
            if (index === -1) return;

            const newIndex = index + direction;
            if (newIndex < 0 || newIndex >= currentKeywords.length) return;

            [currentKeywords[index], currentKeywords[newIndex]] = [currentKeywords[newIndex], currentKeywords[index]];

            const newOrder = currentKeywords.map(k => k.id);
            try {
                const reorderResponse = await Auth.authFetch('/api/admin/featured-keywords/reorder', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ keyword_ids: newOrder })
                });

                if (!reorderResponse.ok) {
                    const errData = await reorderResponse.json();
                    alert(errData.detail || 'ä¸¦ã³æ›¿ãˆã«å¤±æ•—ã—ã¾ã—ãŸ');
                    return;
                }

                loadKeywords();
            } catch (e) {
                alert(e.message);
            }
        }

        async function deleteKeyword(id) {
            if (!confirm('ã“ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;

            try {
                const response = await Auth.authFetch(`/api/admin/featured-keywords/${id}`, {
                    method: 'DELETE'
                });

                if (!response.ok) {
                    const data = await response.json();
                    alert(data.detail || 'å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
                    return;
                }

                loadKeywords();
            } catch (e) {
                alert(e.message);
            }
        }

        async function updateKeywordPrices(id, keyword) {
            if (!confirm(`ã€Œ${keyword}ã€ã®ä¾¡æ ¼ã‚’å„ã‚·ãƒ§ãƒƒãƒ—ã‹ã‚‰å–å¾—ã—ã¾ã™ã€‚\næ•°åç§’ã‹ã‹ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚ç¶šè¡Œã—ã¾ã™ã‹ï¼Ÿ`)) return;

            const btn = event.target;
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = 'æ›´æ–°ä¸­...';

            try {
                const response = await Auth.authFetch(`/api/admin/featured-keywords/${id}/update-prices`, {
                    method: 'POST'
                });

                const data = await response.json();
                if (!response.ok) {
                    alert(data.detail || 'ä¾¡æ ¼æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ');
                    return;
                }

                let resultMsg = `ã€Œ${keyword}ã€ã®ä¾¡æ ¼æ›´æ–°å®Œäº†\n\n`;
                resultMsg += `å–å¾—: ${data.stats.total}ä»¶\n`;
                resultMsg += `æ›´æ–°: ${data.stats.new}ä»¶\n\n`;
                resultMsg += `ã€ã‚·ãƒ§ãƒƒãƒ—åˆ¥ã€‘\n`;
                for (const [shop, stat] of Object.entries(data.stats.shops)) {
                    resultMsg += `${shop}: ${stat.found}ä»¶å–å¾—, ${stat.saved}ä»¶æ›´æ–°\n`;
                }
                alert(resultMsg);

            } catch (e) {
                alert(e.message);
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
            }
        }

        async function updateAllKeywordPrices() {
            if (!confirm('å…¨ã¦ã®äººæ°—ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®ä¾¡æ ¼ã‚’æ›´æ–°ã—ã¾ã™ã€‚\næ•°åˆ†ã‹ã‹ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚ç¶šè¡Œã—ã¾ã™ã‹ï¼Ÿ')) return;

            const btn = document.getElementById('update-all-btn');
            const statusEl = document.getElementById('update-all-status');
            btn.disabled = true;
            btn.textContent = 'æ›´æ–°ä¸­...';
            statusEl.textContent = 'ä¾¡æ ¼ã‚’å–å¾—ã—ã¦ã„ã¾ã™...';

            try {
                const response = await Auth.authFetch('/api/admin/featured-keywords/update-all-prices', {
                    method: 'POST'
                });

                const data = await response.json();
                if (!response.ok) {
                    alert(data.detail || 'ä¾¡æ ¼æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ');
                    statusEl.textContent = 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';
                    return;
                }

                statusEl.textContent = `å®Œäº†: ${data.stats.keywords}ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰, ${data.stats.total}ä»¶å–å¾—, ${data.stats.new}ä»¶æ›´æ–°`;
                alert(`ä¾¡æ ¼æ›´æ–°å®Œäº†\n\nã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ•°: ${data.stats.keywords}\nå–å¾—ä»¶æ•°: ${data.stats.total}\næ›´æ–°ä»¶æ•°: ${data.stats.new}`);

            } catch (e) {
                alert(e.message);
                statusEl.textContent = 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';
            } finally {
                btn.disabled = false;
                btn.textContent = 'å…¨ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®ä¾¡æ ¼ã‚’æ›´æ–°';
            }
        }

        // =================================================================
        // Amazonå•†å“ç®¡ç†
        // =================================================================

        async function loadAmazonProducts() {
            try {
                const response = await Auth.authFetch('/api/admin/amazon-products');
                if (!response.ok) return;
                const data = await response.json();
                renderAmazonProducts(data.products);
            } catch (e) {
                console.error('Failed to load Amazon products:', e);
            }
        }

        function renderAmazonProducts(products) {
            const listEl = document.getElementById('amazon-product-list');
            if (!products || products.length === 0) {
                listEl.innerHTML = '<p class="no-data">å•†å“ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                return;
            }

            listEl.innerHTML = products.map((product, index) => `
                <div class="amazon-item ${product.is_active ? '' : 'inactive'}" data-id="${product.id}">
                    <a href="${escapeHtml(product.affiliate_url)}" target="_blank" rel="noopener"><img src="${escapeHtml(product.image_url)}" alt="${escapeHtml(product.name)}" class="amazon-item-img" onerror="this.style.display='none'"></a>
                    <div class="amazon-item-info">
                        <a href="${escapeHtml(product.affiliate_url)}" target="_blank" rel="noopener" style="color:#4fc3f7;text-decoration:none"><div class="amazon-item-name">${escapeHtml(product.name)}</div></a>
                        <div class="amazon-item-price">${product.price_text}</div>
                    </div>
                    <div class="amazon-item-actions">
                        <button class="keyword-btn" onclick="editAmazonProduct(${product.id})" style="background:#2196F3">ç·¨é›†</button>
                        <button class="keyword-btn toggle-btn" onclick="toggleAmazonProduct(${product.id}, ${product.is_active})">
                            ${product.is_active ? 'è¡¨ç¤ºä¸­' : 'éè¡¨ç¤º'}
                        </button>
                        <button class="keyword-btn move-btn" onclick="moveAmazonProduct(${product.id}, -1)" ${index === 0 ? 'disabled' : ''}>â†‘</button>
                        <button class="keyword-btn move-btn" onclick="moveAmazonProduct(${product.id}, 1)" ${index === products.length - 1 ? 'disabled' : ''}>â†“</button>
                        <button class="keyword-btn delete-btn" onclick="deleteAmazonProduct(${product.id})">Ã—</button>
                    </div>
                </div>
            `).join('');
        }

        async function editAmazonProduct(productId) {
            const item = document.querySelector(`.amazon-item[data-id="${productId}"]`);
            if (!item) return;

            const nameEl = item.querySelector('.amazon-item-name');
            const priceEl = item.querySelector('.amazon-item-price');
            const imgEl = item.querySelector('.amazon-item-img');

            const currentName = nameEl ? nameEl.textContent : '';
            const currentPrice = priceEl ? priceEl.textContent.replace(/[^0-9]/g, '') : '';
            const currentImage = imgEl ? imgEl.src : '';

            const newName = prompt('å•†å“å:', currentName);
            if (newName === null) return;

            const newPrice = prompt('ä¾¡æ ¼:', currentPrice);
            if (newPrice === null) return;

            const newImageUrl = prompt('ç”»åƒURL:', currentImage);
            if (newImageUrl === null) return;

            try {
                const response = await Auth.authFetch(`/api/admin/amazon-products/${productId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: newName || undefined,
                        price: newPrice ? parseInt(newPrice) : undefined,
                        image_url: newImageUrl || undefined
                    })
                });
                if (response.ok) {
                    alert('æ›´æ–°ã—ã¾ã—ãŸ');
                    loadAmazonProducts();
                } else {
                    const err = await response.json();
                    alert('ã‚¨ãƒ©ãƒ¼: ' + (err.detail || 'æ›´æ–°å¤±æ•—'));
                }
            } catch (e) {
                alert('ã‚¨ãƒ©ãƒ¼: ' + e.message);
            }
        }

        async function handleAddAmazonProduct(event) {
            event.preventDefault();
            const errorEl = document.getElementById('amazon-error');
            const successEl = document.getElementById('amazon-success');
            errorEl.textContent = '';
            successEl.textContent = '';

            const url = document.getElementById('amazon-url').value;
            const name = document.getElementById('amazon-name').value;
            const price = parseInt(document.getElementById('amazon-price').value);
            const imageUrl = document.getElementById('amazon-image').value;

            try {
                const response = await Auth.authFetch('/api/admin/amazon-products', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url, name, price, image_url: imageUrl })
                });

                const data = await response.json();
                if (!response.ok) {
                    errorEl.textContent = data.detail || 'è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ';
                    return;
                }

                successEl.textContent = `ã€Œ${name}ã€ã‚’è¿½åŠ ã—ã¾ã—ãŸ`;
                document.getElementById('amazon-url').value = '';
                document.getElementById('amazon-name').value = '';
                document.getElementById('amazon-price').value = '';
                document.getElementById('amazon-image').value = '';
                loadAmazonProducts();
            } catch (e) {
                errorEl.textContent = e.message;
            }
        }

        async function toggleAmazonProduct(id, currentActive) {
            try {
                const response = await Auth.authFetch(`/api/admin/amazon-products/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ is_active: currentActive ? 0 : 1 })
                });

                if (!response.ok) {
                    const data = await response.json();
                    alert(data.detail || 'æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ');
                    return;
                }

                loadAmazonProducts();
            } catch (e) {
                alert(e.message);
            }
        }

        let currentAmazonProducts = [];
        async function moveAmazonProduct(id, direction) {
            const response = await Auth.authFetch('/api/admin/amazon-products');
            if (!response.ok) return;
            const data = await response.json();
            currentAmazonProducts = data.products;

            const index = currentAmazonProducts.findIndex(p => p.id === id);
            if (index === -1) return;

            const newIndex = index + direction;
            if (newIndex < 0 || newIndex >= currentAmazonProducts.length) return;

            [currentAmazonProducts[index], currentAmazonProducts[newIndex]] = [currentAmazonProducts[newIndex], currentAmazonProducts[index]];

            const newOrder = currentAmazonProducts.map(p => p.id);
            try {
                const reorderResponse = await Auth.authFetch('/api/admin/amazon-products/reorder', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ product_ids: newOrder })
                });

                if (!reorderResponse.ok) {
                    const errData = await reorderResponse.json();
                    alert(errData.detail || 'ä¸¦ã³æ›¿ãˆã«å¤±æ•—ã—ã¾ã—ãŸ');
                    return;
                }

                loadAmazonProducts();
            } catch (e) {
                alert(e.message);
            }
        }

        async function deleteAmazonProduct(id) {
            if (!confirm('ã“ã®å•†å“ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;

            try {
                const response = await Auth.authFetch(`/api/admin/amazon-products/${id}`, {
                    method: 'DELETE'
                });

                if (!response.ok) {
                    const data = await response.json();
                    alert(data.detail || 'å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
                    return;
                }

                loadAmazonProducts();
            } catch (e) {
                alert(e.message);
            }
        }

        // =================================================================
        // æ¥½å¤©å•†å“ç®¡ç†
        // =================================================================

        async function loadRakutenProducts() {
            try {
                const response = await Auth.authFetch('/api/admin/rakuten-products');
                if (!response.ok) return;
                const data = await response.json();
                renderRakutenProducts(data.products);
            } catch (e) {
                console.error('Failed to load Rakuten products:', e);
            }
        }

        function renderRakutenProducts(products) {
            const listEl = document.getElementById('rakuten-product-list');
            if (!products || products.length === 0) {
                listEl.innerHTML = '<p class="no-data">å•†å“ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                return;
            }

            listEl.innerHTML = products.map((product, index) => `
                <div class="amazon-item ${product.is_active ? '' : 'inactive'}" data-id="${product.id}">
                    <a href="${escapeHtml(product.affiliate_url)}" target="_blank" rel="noopener"><img src="${escapeHtml(product.image_url)}" alt="${escapeHtml(product.name)}" class="amazon-item-img" onerror="this.style.display='none'"></a>
                    <div class="amazon-item-info">
                        <a href="${escapeHtml(product.affiliate_url)}" target="_blank" rel="noopener" style="color:#bf0000;text-decoration:none"><div class="amazon-item-name">${escapeHtml(product.name)}</div></a>
                        <div class="amazon-item-price">${product.price_text}</div>
                    </div>
                    <div class="amazon-item-actions">
                        <button class="keyword-btn" onclick="editRakutenProduct(${product.id})" style="background:#2196F3">ç·¨é›†</button>
                        <button class="keyword-btn toggle-btn" onclick="toggleRakutenProduct(${product.id}, ${product.is_active})">
                            ${product.is_active ? 'è¡¨ç¤ºä¸­' : 'éè¡¨ç¤º'}
                        </button>
                        <button class="keyword-btn move-btn" onclick="moveRakutenProduct(${product.id}, -1)" ${index === 0 ? 'disabled' : ''}>â†‘</button>
                        <button class="keyword-btn move-btn" onclick="moveRakutenProduct(${product.id}, 1)" ${index === products.length - 1 ? 'disabled' : ''}>â†“</button>
                        <button class="keyword-btn delete-btn" onclick="deleteRakutenProduct(${product.id})">Ã—</button>
                    </div>
                </div>
            `).join('');
        }

        async function editRakutenProduct(productId) {
            const item = document.querySelector(`.amazon-item[data-id="${productId}"]`);
            if (!item) return;

            const nameEl = item.querySelector('.amazon-item-name');
            const priceEl = item.querySelector('.amazon-item-price');
            const imgEl = item.querySelector('.amazon-item-img');

            const currentName = nameEl ? nameEl.textContent : '';
            const currentPrice = priceEl ? priceEl.textContent.replace(/[^0-9]/g, '') : '';
            const currentImage = imgEl ? imgEl.src : '';

            const newName = prompt('å•†å“å:', currentName);
            if (newName === null) return;

            const newPrice = prompt('ä¾¡æ ¼:', currentPrice);
            if (newPrice === null) return;

            const newImageUrl = prompt('ç”»åƒURL:', currentImage);
            if (newImageUrl === null) return;

            try {
                const response = await Auth.authFetch(`/api/admin/rakuten-products/${productId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: newName || undefined,
                        price: newPrice ? parseInt(newPrice) : undefined,
                        image_url: newImageUrl || undefined
                    })
                });
                if (response.ok) {
                    alert('æ›´æ–°ã—ã¾ã—ãŸ');
                    loadRakutenProducts();
                } else {
                    const err = await response.json();
                    alert('ã‚¨ãƒ©ãƒ¼: ' + (err.detail || 'æ›´æ–°å¤±æ•—'));
                }
            } catch (e) {
                alert('ã‚¨ãƒ©ãƒ¼: ' + e.message);
            }
        }

        async function handleAddRakutenProduct(event) {
            event.preventDefault();
            const errorEl = document.getElementById('rakuten-error');
            const successEl = document.getElementById('rakuten-success');
            errorEl.textContent = '';
            successEl.textContent = '';

            const affiliateUrl = document.getElementById('rakuten-url').value;
            const name = document.getElementById('rakuten-name').value;
            const price = parseInt(document.getElementById('rakuten-price').value);
            const imageUrl = document.getElementById('rakuten-image').value;

            try {
                const response = await Auth.authFetch('/api/admin/rakuten-products', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, price, image_url: imageUrl, affiliate_url: affiliateUrl })
                });

                const data = await response.json();
                if (!response.ok) {
                    errorEl.textContent = data.detail || 'è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ';
                    return;
                }

                successEl.textContent = `ã€Œ${name}ã€ã‚’è¿½åŠ ã—ã¾ã—ãŸ`;
                document.getElementById('rakuten-url').value = '';
                document.getElementById('rakuten-name').value = '';
                document.getElementById('rakuten-price').value = '';
                document.getElementById('rakuten-image').value = '';
                loadRakutenProducts();
            } catch (e) {
                errorEl.textContent = e.message;
            }
        }

        async function toggleRakutenProduct(id, currentActive) {
            try {
                const response = await Auth.authFetch(`/api/admin/rakuten-products/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ is_active: currentActive ? 0 : 1 })
                });

                if (!response.ok) {
                    const data = await response.json();
                    alert(data.detail || 'æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ');
                    return;
                }

                loadRakutenProducts();
            } catch (e) {
                alert(e.message);
            }
        }

        let rakutenProducts = [];
        async function moveRakutenProduct(id, direction) {
            const response = await Auth.authFetch('/api/admin/rakuten-products');
            if (!response.ok) return;
            const data = await response.json();
            rakutenProducts = data.products;

            const currentIndex = rakutenProducts.findIndex(p => p.id === id);
            const newIndex = currentIndex + direction;

            if (newIndex < 0 || newIndex >= rakutenProducts.length) return;

            [rakutenProducts[currentIndex], rakutenProducts[newIndex]] =
            [rakutenProducts[newIndex], rakutenProducts[currentIndex]];

            const productIds = rakutenProducts.map(p => p.id);
            await Auth.authFetch('/api/admin/rakuten-products/reorder', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ product_ids: productIds })
            });

            loadRakutenProducts();
        }

        async function deleteRakutenProduct(id) {
            if (!confirm('ã“ã®å•†å“ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;

            try {
                const response = await Auth.authFetch(`/api/admin/rakuten-products/${id}`, {
                    method: 'DELETE'
                });

                if (!response.ok) {
                    const data = await response.json();
                    alert(data.detail || 'å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
                    return;
                }

                loadRakutenProducts();
            } catch (e) {
                alert(e.message);
            }
        }

        // =================================================================
        // ã‚¢ã‚¯ã‚»ã‚¹è§£æ
        // =================================================================

        async function loadAnalytics() {
            const period = document.getElementById('analytics-period').value;
            const days = parseInt(document.getElementById('analytics-days').value);

            await Promise.all([
                loadSearchStats(period, days),
                loadClickStats(period, days),
                loadKeywordRanking(days),
                loadShopRanking(days),
                loadCardRanking(days)
            ]);
        }

        async function loadSearchStats(period, days) {
            try {
                const response = await Auth.authFetch(`/api/admin/analytics/searches?period=${period}&days=${days}`);
                if (!response.ok) return;
                const data = await response.json();
                renderBarChart('search-stats-chart', data.stats, 'æ¤œç´¢æ•°');
            } catch (e) {
                console.error('Failed to load search stats:', e);
            }
        }

        async function loadClickStats(period, days) {
            try {
                const response = await Auth.authFetch(`/api/admin/analytics/clicks?period=${period}&days=${days}`);
                if (!response.ok) return;
                const data = await response.json();
                renderBarChart('click-stats-chart', data.stats, 'ã‚¯ãƒªãƒƒã‚¯æ•°');
            } catch (e) {
                console.error('Failed to load click stats:', e);
            }
        }

        async function loadKeywordRanking(days) {
            try {
                const response = await Auth.authFetch(`/api/admin/analytics/keywords?days=${days}&limit=20`);
                if (!response.ok) return;
                const data = await response.json();
                renderRanking('keyword-ranking', data.ranking, 'keyword', 'count', 'å›');
            } catch (e) {
                console.error('Failed to load keyword ranking:', e);
            }
        }

        async function loadShopRanking(days) {
            try {
                const response = await Auth.authFetch(`/api/admin/analytics/shops?days=${days}`);
                if (!response.ok) return;
                const data = await response.json();
                renderRanking('shop-ranking', data.ranking, 'shop_name', 'count', 'ã‚¯ãƒªãƒƒã‚¯');
            } catch (e) {
                console.error('Failed to load shop ranking:', e);
            }
        }

        async function loadCardRanking(days) {
            try {
                const response = await Auth.authFetch(`/api/admin/analytics/cards?days=${days}&limit=20`);
                if (!response.ok) return;
                const data = await response.json();
                renderRanking('card-ranking', data.ranking, 'card_name', 'count', 'ã‚¯ãƒªãƒƒã‚¯');
            } catch (e) {
                console.error('Failed to load card ranking:', e);
            }
        }

        function renderBarChart(containerId, data, label) {
            const container = document.getElementById(containerId);
            if (!data || data.length === 0) {
                container.innerHTML = '<p class="no-data">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                return;
            }

            // æ—¥ä»˜é †ã«ä¸¦ã³æ›¿ãˆ
            const sortedData = [...data].sort((a, b) => a.date.localeCompare(b.date));
            const maxCount = Math.max(...sortedData.map(d => d.count));

            // å¯¾æ•°ã‚¹ã‚±ãƒ¼ãƒ«ã§é«˜ã•ã‚’è¨ˆç®—ï¼ˆå°ã•ã„å€¤ã‚‚è¦‹ãˆã‚‹ã‚ˆã†ã«ï¼‰
            const logScale = (value, max) => {
                if (value <= 0) return 0;
                if (max <= 0) return 0;
                // log(1) = 0 ãªã®ã§ +1 ã—ã¦ã‹ã‚‰è¨ˆç®—
                const logValue = Math.log10(value + 1);
                const logMax = Math.log10(max + 1);
                return (logValue / logMax) * 100;
            };

            container.innerHTML = `
                <div class="chart-container">
                    ${sortedData.map(item => {
                        const height = logScale(item.count, maxCount);
                        return `
                            <div class="chart-bar-wrapper">
                                <div class="chart-bar" style="height: ${Math.max(height, item.count > 0 ? 15 : 0)}%;" title="${item.date}: ${item.count}">
                                    <span class="chart-bar-value">${item.count}</span>
                                </div>
                                <div class="chart-bar-label">${item.date.slice(-5)}</div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        function renderRanking(containerId, data, nameKey, countKey, unit) {
            const container = document.getElementById(containerId);
            if (!data || data.length === 0) {
                container.innerHTML = '<p class="no-data">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                return;
            }

            const maxCount = Math.max(...data.map(d => d[countKey]));

            // å¯¾æ•°ã‚¹ã‚±ãƒ¼ãƒ«ã§å¹…ã‚’è¨ˆç®—
            const logScale = (value, max) => {
                if (value <= 0) return 0;
                if (max <= 0) return 0;
                const logValue = Math.log10(value + 1);
                const logMax = Math.log10(max + 1);
                return (logValue / logMax) * 100;
            };

            container.innerHTML = data.map((item, index) => {
                const percentage = Math.max(logScale(item[countKey], maxCount), item[countKey] > 0 ? 15 : 0);
                return `
                    <div class="ranking-item">
                        <span class="ranking-rank">${index + 1}</span>
                        <span class="ranking-name">${escapeHtml(item[nameKey])}</span>
                        <div class="ranking-bar-container">
                            <div class="ranking-bar" style="width: ${percentage}%;"></div>
                        </div>
                        <span class="ranking-count">${item[countKey].toLocaleString()} ${unit}</span>
                    </div>
                `;
            }).join('');
        }

        // =================================================================
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†
        // =================================================================

        let userCurrentPage = 0;
        const userPageSize = 20;

        async function loadUsers(page = 0) {
            userCurrentPage = page;
            const search = document.getElementById('user-search').value.trim();
            const offset = page * userPageSize;

            try {
                const params = new URLSearchParams({
                    limit: userPageSize,
                    offset: offset
                });
                if (search) params.append('search', search);

                const response = await Auth.authFetch(`/api/admin/users?${params}`);
                if (!response.ok) return;
                const data = await response.json();
                renderUsers(data.users, data.total);
            } catch (e) {
                console.error('Failed to load users:', e);
            }
        }

        function handleUserSearch(event) {
            if (event.key === 'Enter') {
                loadUsers(0);
            }
        }

        function renderUsers(users, total) {
            const listEl = document.getElementById('user-list');
            const paginationEl = document.getElementById('user-pagination');

            if (!users || users.length === 0) {
                listEl.innerHTML = '<p class="no-data">ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã„ã¾ã›ã‚“</p>';
                paginationEl.innerHTML = '';
                return;
            }

            listEl.innerHTML = `
                <div class="user-list-header">
                    <span class="user-col-id">ID</span>
                    <span class="user-col-name">ãƒ¦ãƒ¼ã‚¶ãƒ¼å</span>
                    <span class="user-col-email">ãƒ¡ãƒ¼ãƒ«</span>
                    <span class="user-col-role">æ¨©é™</span>
                    <span class="user-col-status">çŠ¶æ…‹</span>
                    <span class="user-col-date">ç™»éŒ²æ—¥</span>
                    <span class="user-col-actions">æ“ä½œ</span>
                </div>
                ${users.map(user => `
                    <div class="user-list-item ${user.is_active ? '' : 'banned'}" data-id="${user.id}">
                        <span class="user-col-id">${user.id}</span>
                        <span class="user-col-name">${escapeHtml(user.username)}</span>
                        <span class="user-col-email">${escapeHtml(user.email)}</span>
                        <span class="user-col-role">
                            <span class="role-badge ${user.role}">${user.role === 'admin' ? 'ç®¡ç†è€…' : 'ãƒ¦ãƒ¼ã‚¶ãƒ¼'}</span>
                        </span>
                        <span class="user-col-status">
                            <span class="status-badge ${user.is_active ? 'active' : 'banned'}">${user.is_active ? 'ã‚¢ã‚¯ãƒ†ã‚£ãƒ–' : 'BAN'}</span>
                        </span>
                        <span class="user-col-date">${formatDate(user.created_at)}</span>
                        <span class="user-col-actions">
                            ${currentAdmin && currentAdmin.id !== user.id ? `
                                <button class="user-btn toggle-role-btn" onclick="toggleUserRole(${user.id}, '${user.role}')" title="${user.role === 'admin' ? 'ä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å¤‰æ›´' : 'ç®¡ç†è€…ã«ã™ã‚‹'}">
                                    ${user.role === 'admin' ? 'æ¨©é™å‰¥å¥ª' : 'ç®¡ç†è€…åŒ–'}
                                </button>
                                <button class="user-btn toggle-ban-btn ${user.is_active ? '' : 'unban'}" onclick="toggleUserBan(${user.id}, ${user.is_active})" title="${user.is_active ? 'BANã™ã‚‹' : 'BANè§£é™¤'}">
                                    ${user.is_active ? 'BAN' : 'è§£é™¤'}
                                </button>
                            ` : '<span class="self-label">è‡ªåˆ†</span>'}
                        </span>
                    </div>
                `).join('')}
            `;

            const totalPages = Math.ceil(total / userPageSize);
            if (totalPages <= 1) {
                paginationEl.innerHTML = `<span class="page-info">${total}ä»¶</span>`;
                return;
            }

            let paginationHtml = `<span class="page-info">${total}ä»¶ä¸­ ${userCurrentPage * userPageSize + 1}-${Math.min((userCurrentPage + 1) * userPageSize, total)}ä»¶</span>`;

            if (userCurrentPage > 0) {
                paginationHtml += `<button class="page-btn" onclick="loadUsers(${userCurrentPage - 1})">å‰ã¸</button>`;
            }

            paginationHtml += `<span class="page-current">${userCurrentPage + 1} / ${totalPages}</span>`;

            if (userCurrentPage < totalPages - 1) {
                paginationHtml += `<button class="page-btn" onclick="loadUsers(${userCurrentPage + 1})">æ¬¡ã¸</button>`;
            }

            paginationEl.innerHTML = paginationHtml;
        }

        async function toggleUserRole(userId, currentRole) {
            const newRole = currentRole === 'admin' ? 'user' : 'admin';
            const action = newRole === 'admin' ? 'ç®¡ç†è€…æ¨©é™ã‚’ä»˜ä¸' : 'ç®¡ç†è€…æ¨©é™ã‚’å‰¥å¥ª';

            if (!confirm(`ã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®${action}ã—ã¾ã™ã‹ï¼Ÿ`)) return;

            try {
                const response = await Auth.authFetch(`/api/admin/users/${userId}/role`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ role: newRole })
                });

                const data = await response.json();
                if (!response.ok) {
                    alert(data.detail || 'å¤‰æ›´ã«å¤±æ•—ã—ã¾ã—ãŸ');
                    return;
                }

                alert(data.message);
                loadUsers(userCurrentPage);
            } catch (e) {
                alert(e.message);
            }
        }

        async function toggleUserBan(userId, isActive) {
            const action = isActive ? 'BAN' : 'BANè§£é™¤';

            if (!confirm(`ã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’${action}ã—ã¾ã™ã‹ï¼Ÿ`)) return;

            try {
                const response = await Auth.authFetch(`/api/admin/users/${userId}/status`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ is_active: isActive ? 0 : 1 })
                });

                const data = await response.json();
                if (!response.ok) {
                    alert(data.detail || 'å¤‰æ›´ã«å¤±æ•—ã—ã¾ã—ãŸ');
                    return;
                }

                alert(data.message);
                loadUsers(userCurrentPage);
            } catch (e) {
                alert(e.message);
            }
        }

        // =================================================================
        // ãã®ä»–
        // =================================================================

        async function handleUpdatePopular() {
            const successEl = document.getElementById('popular-success');
            successEl.textContent = '';

            try {
                const response = await Auth.authFetch('/api/admin/update-popular', {
                    method: 'POST'
                });

                const data = await response.json();
                if (!response.ok) {
                    alert(data.detail || 'æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ');
                    return;
                }

                successEl.textContent = data.message;
            } catch (e) {
                alert(e.message);
            }
        }

        async function handleGenerateInvite() {
            try {
                const response = await Auth.authFetch('/api/admin/invites', {
                    method: 'POST'
                });

                const data = await response.json();
                if (!response.ok) {
                    alert(data.detail || 'ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ');
                    return;
                }

                alert(`æ‹›å¾…ã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆã—ã¾ã—ãŸ: ${data.invite.code}`);
                loadInvites();
            } catch (e) {
                alert(e.message);
            }
        }

        function copyInviteCode(code) {
            navigator.clipboard.writeText(code).then(() => {
                alert('æ‹›å¾…ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
            }).catch(() => {
                prompt('æ‹›å¾…ã‚³ãƒ¼ãƒ‰:', code);
            });
        }

        // ===========================================
        // ã‚«ãƒ¼ãƒ‰çµ±åˆæ©Ÿèƒ½
        // ===========================================

        let selectedCardsForGroup = [];
        let groupSearchTimeout = null;

        // ã‚«ãƒ¼ãƒ‰æ¤œç´¢ï¼ˆçµ±åˆç”¨ï¼‰
        function handleGroupCardSearch(event) {
            clearTimeout(groupSearchTimeout);
            const query = event.target.value.trim();

            if (query.length < 2) {
                document.getElementById('group-search-results').innerHTML = '';
                return;
            }

            groupSearchTimeout = setTimeout(() => {
                searchCardsForGroup(query);
            }, 300);
        }

        async function searchCardsForGroup(query) {
            const resultsEl = document.getElementById('group-search-results');
            resultsEl.innerHTML = '<p>æ¤œç´¢ä¸­...</p>';

            try {
                const response = await fetch(`/api/admin/cards/search?q=${encodeURIComponent(query)}`, {
                    headers: { 'Authorization': `Bearer ${Auth.getToken()}` }
                });

                if (!response.ok) throw new Error('æ¤œç´¢ã«å¤±æ•—ã—ã¾ã—ãŸ');

                const data = await response.json();

                if (data.cards.length === 0) {
                    resultsEl.innerHTML = '<p>ã‚«ãƒ¼ãƒ‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</p>';
                    return;
                }

                resultsEl.innerHTML = data.cards.map(card => {
                    const isSelected = selectedCardsForGroup.some(c => c.id === card.id);
                    const cardNo = card.extracted_card_no || 'ç•ªå·ãªã—';
                    const shopName = card.shop_name || '';
                    const minPrice = card.min_price ? `${card.min_price.toLocaleString()}å††` : '';

                    return `
                        <div class="group-search-item ${isSelected ? 'selected' : ''}"
                             onclick="toggleCardSelection(${card.id}, '${escapeHtml(card.name)}', '${cardNo}')">
                            <div class="search-item-name">${escapeHtml(card.name)}</div>
                            <div class="search-item-meta">
                                <span class="card-no-badge">${cardNo}</span>
                                ${shopName ? `<span class="shop-badge">${shopName}</span>` : ''}
                                ${minPrice ? `<span class="price-badge">${minPrice}</span>` : ''}
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                resultsEl.innerHTML = `<p class="error">${error.message}</p>`;
            }
        }

        function toggleCardSelection(cardId, cardName, cardNo) {
            const index = selectedCardsForGroup.findIndex(c => c.id === cardId);

            if (index >= 0) {
                selectedCardsForGroup.splice(index, 1);
            } else {
                selectedCardsForGroup.push({ id: cardId, name: cardName, cardNo: cardNo });
            }

            updateSelectedCardsDisplay();

            // æ¤œç´¢çµæœã®é¸æŠçŠ¶æ…‹ã‚‚æ›´æ–°
            const searchItems = document.querySelectorAll('.group-search-item');
            searchItems.forEach(item => {
                const onclick = item.getAttribute('onclick');
                if (onclick && onclick.includes(`(${cardId},`)) {
                    item.classList.toggle('selected', selectedCardsForGroup.some(c => c.id === cardId));
                }
            });
        }

        function updateSelectedCardsDisplay() {
            const listEl = document.getElementById('selected-cards-list');
            const countEl = document.getElementById('selected-count');
            const createBtn = document.getElementById('create-group-btn');

            countEl.textContent = selectedCardsForGroup.length;
            createBtn.disabled = selectedCardsForGroup.length < 2;

            if (selectedCardsForGroup.length === 0) {
                listEl.innerHTML = '<p class="empty-message">çµ±åˆã™ã‚‹ã‚«ãƒ¼ãƒ‰ã‚’é¸æŠã—ã¦ãã ã•ã„ï¼ˆ2ä»¶ä»¥ä¸Šï¼‰</p>';
                return;
            }

            listEl.innerHTML = selectedCardsForGroup.map(card => `
                <div class="selected-card-item">
                    <span class="card-name">${escapeHtml(card.name)}</span>
                    <span class="card-no">${card.cardNo}</span>
                    <button class="remove-btn" onclick="toggleCardSelection(${card.id}, '', '')">&times;</button>
                </div>
            `).join('');
        }

        async function handleCreateGroup() {
            const nameEl = document.getElementById('group-name');
            const errorEl = document.getElementById('group-error');
            const successEl = document.getElementById('group-success');

            errorEl.textContent = '';
            successEl.textContent = '';

            const groupName = nameEl.value.trim() || selectedCardsForGroup[0]?.name || 'ã‚°ãƒ«ãƒ¼ãƒ—';

            if (selectedCardsForGroup.length < 2) {
                errorEl.textContent = '2ä»¶ä»¥ä¸Šã®ã‚«ãƒ¼ãƒ‰ã‚’é¸æŠã—ã¦ãã ã•ã„';
                return;
            }

            try {
                const response = await fetch('/api/admin/card-groups', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${Auth.getToken()}`
                    },
                    body: JSON.stringify({
                        name: groupName,
                        card_ids: selectedCardsForGroup.map(c => c.id)
                    })
                });

                if (!response.ok) throw new Error('ã‚°ãƒ«ãƒ¼ãƒ—ã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ');

                successEl.textContent = 'ã‚°ãƒ«ãƒ¼ãƒ—ã‚’ä½œæˆã—ã¾ã—ãŸ';
                selectedCardsForGroup = [];
                nameEl.value = '';
                document.getElementById('group-card-search').value = '';
                document.getElementById('group-search-results').innerHTML = '';
                updateSelectedCardsDisplay();
                loadCardGroups();
            } catch (error) {
                errorEl.textContent = error.message;
            }
        }

        async function loadCardGroups() {
            const listEl = document.getElementById('card-groups-list');
            listEl.innerHTML = '<p>èª­ã¿è¾¼ã¿ä¸­...</p>';

            try {
                const response = await fetch('/api/admin/card-groups', {
                    headers: { 'Authorization': `Bearer ${Auth.getToken()}` }
                });

                if (!response.ok) throw new Error('èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');

                const data = await response.json();

                if (data.groups.length === 0) {
                    listEl.innerHTML = '<p>ã‚°ãƒ«ãƒ¼ãƒ—ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                    return;
                }

                listEl.innerHTML = data.groups.map(group => `
                    <div class="card-group-item">
                        <div class="group-header">
                            <span class="group-name">${escapeHtml(group.name)}</span>
                            <span class="group-count">${group.member_count}ä»¶</span>
                            <button class="admin-btn admin-btn-small" onclick="toggleGroupDetail(${group.id})">è©³ç´°</button>
                            <button class="admin-btn admin-btn-danger admin-btn-small" onclick="handleDeleteGroup(${group.id})">å‰Šé™¤</button>
                        </div>
                        <div class="group-detail" id="group-detail-${group.id}" style="display: none;"></div>
                    </div>
                `).join('');
            } catch (error) {
                listEl.innerHTML = `<p class="error">${error.message}</p>`;
            }
        }

        async function toggleGroupDetail(groupId) {
            const detailEl = document.getElementById(`group-detail-${groupId}`);

            if (detailEl.style.display === 'block') {
                detailEl.style.display = 'none';
                return;
            }

            detailEl.innerHTML = '<p>èª­ã¿è¾¼ã¿ä¸­...</p>';
            detailEl.style.display = 'block';

            try {
                const response = await fetch(`/api/admin/card-groups/${groupId}/members`, {
                    headers: { 'Authorization': `Bearer ${Auth.getToken()}` }
                });

                if (!response.ok) throw new Error('èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');

                const data = await response.json();

                detailEl.innerHTML = data.members.map(card => `
                    <div class="group-member-item">
                        <span class="member-name">${escapeHtml(card.name)}</span>
                        <span class="member-no">${card.extracted_card_no || 'ç•ªå·ãªã—'}</span>
                        <span class="member-price">${card.min_price ? card.min_price.toLocaleString() + 'å††' : ''}</span>
                        <button class="admin-btn admin-btn-danger admin-btn-small" onclick="handleRemoveFromGroup(${groupId}, ${card.id})">é™¤å¤–</button>
                    </div>
                `).join('');
            } catch (error) {
                detailEl.innerHTML = `<p class="error">${error.message}</p>`;
            }
        }

        async function handleDeleteGroup(groupId) {
            if (!confirm('ã“ã®ã‚°ãƒ«ãƒ¼ãƒ—ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;

            try {
                const response = await fetch(`/api/admin/card-groups/${groupId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${Auth.getToken()}` }
                });

                if (!response.ok) throw new Error('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');

                loadCardGroups();
            } catch (error) {
                alert(error.message);
            }
        }

        async function handleRemoveFromGroup(groupId, cardId) {
            try {
                const response = await fetch(`/api/admin/card-groups/${groupId}/members/${cardId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${Auth.getToken()}` }
                });

                if (!response.ok) throw new Error('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');

                toggleGroupDetail(groupId);  // è©³ç´°ã‚’å†èª­ã¿è¾¼ã¿
            } catch (error) {
                alert(error.message);
            }
        }

        // =============================================================================
        // XæŠ•ç¨¿ã‚­ãƒ¥ãƒ¼
        // =============================================================================

        async function loadXPosts() {
            const listEl = document.getElementById('x-posts-list');
            const pendingOnly = document.getElementById('x-posts-pending-only').checked;

            listEl.innerHTML = '<p>èª­ã¿è¾¼ã¿ä¸­...</p>';

            try {
                const response = await fetch(`/api/admin/x-posts?pending_only=${pendingOnly}&limit=50`, {
                    headers: { 'Authorization': `Bearer ${Auth.getToken()}` }
                });

                if (!response.ok) throw new Error('èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');

                const data = await response.json();

                if (data.posts.length === 0) {
                    listEl.innerHTML = '<p class="no-data">æŠ•ç¨¿ã‚­ãƒ¥ãƒ¼ã¯ã‚ã‚Šã¾ã›ã‚“</p>';
                    return;
                }

                listEl.innerHTML = data.posts.map(post => `
                    <div class="x-post-item ${post.status === 'posted' ? 'posted' : 'pending'}">
                        <div class="x-post-header">
                            <span class="x-post-type">${getPostTypeLabel(post.post_type)}</span>
                            <span class="x-post-status ${post.status}">${post.status === 'posted' ? 'æŠ•ç¨¿æ¸ˆã¿' : 'æœªæŠ•ç¨¿'}</span>
                            <span class="x-post-date">${formatDate(post.created_at)}</span>
                        </div>
                        <div class="x-post-content">
                            <pre>${escapeHtml(post.content)}</pre>
                        </div>
                        <div class="x-post-actions">
                            ${post.status === 'pending' ? `
                                <a href="https://twitter.com/intent/tweet?text=${encodeURIComponent(post.content)}"
                                   target="_blank"
                                   class="admin-btn admin-btn-small"
                                   onclick="markAsPosted(${post.id})">
                                   Xã§æŠ•ç¨¿
                                </a>
                                <button class="admin-btn admin-btn-small admin-btn-secondary" onclick="copyToClipboard('${escapeForJs(post.content)}')">ã‚³ãƒ”ãƒ¼</button>
                                <button class="admin-btn admin-btn-small admin-btn-danger" onclick="deleteXPost(${post.id})">å‰Šé™¤</button>
                            ` : `
                                <span class="posted-at">æŠ•ç¨¿æ—¥æ™‚: ${formatDate(post.posted_at)}</span>
                            `}
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                listEl.innerHTML = `<p class="error">${error.message}</p>`;
            }
        }

        function getPostTypeLabel(type) {
            switch (type) {
                case 'price_drop': return 'ğŸ“‰ å€¤ä¸‹ã’';
                case 'price_rise': return 'ğŸ“ˆ å€¤ä¸Šã’';
                case 'summary': return 'ğŸ“Š ã¾ã¨ã‚';
                default: return type;
            }
        }

        async function markAsPosted(postId) {
            try {
                await fetch(`/api/admin/x-posts/${postId}/posted`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${Auth.getToken()}` }
                });
                // å°‘ã—å¾…ã£ã¦ã‹ã‚‰ãƒªãƒ­ãƒ¼ãƒ‰ï¼ˆæŠ•ç¨¿ç”»é¢ãŒé–‹ã„ã¦ã‹ã‚‰ï¼‰
                setTimeout(() => loadXPosts(), 1000);
            } catch (error) {
                console.error('Failed to mark as posted:', error);
            }
        }

        async function deleteXPost(postId) {
            if (!confirm('ã“ã®æŠ•ç¨¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;

            try {
                const response = await fetch(`/api/admin/x-posts/${postId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${Auth.getToken()}` }
                });

                if (!response.ok) throw new Error('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');

                loadXPosts();
            } catch (error) {
                alert(error.message);
            }
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                alert('ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
            }).catch(err => {
                console.error('Failed to copy:', err);
            });
        }

        // ã‚«ã‚¹ã‚¿ãƒ æŠ•ç¨¿ã®æ–‡å­—æ•°ã‚«ã‚¦ãƒ³ãƒˆ
        document.addEventListener('DOMContentLoaded', () => {
            const textarea = document.getElementById('custom-post-content');
            const counter = document.getElementById('custom-post-count');
            if (textarea && counter) {
                textarea.addEventListener('input', () => {
                    const len = textarea.value.length;
                    counter.textContent = `${len} / 280æ–‡å­—`;
                    counter.style.color = len > 280 ? '#ef4444' : 'var(--text-secondary)';
                });
            }
        });

        // ã‚«ã‚¹ã‚¿ãƒ æŠ•ç¨¿ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
        function previewCustomPost() {
            const content = document.getElementById('custom-post-content').value.trim();
            if (!content) {
                alert('æŠ•ç¨¿å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(content)}`, '_blank');
        }

        // ã‚«ã‚¹ã‚¿ãƒ æŠ•ç¨¿ã‚’ã‚­ãƒ¥ãƒ¼ã«è¿½åŠ 
        async function createCustomPost() {
            const textarea = document.getElementById('custom-post-content');
            const content = textarea.value.trim();

            if (!content) {
                alert('æŠ•ç¨¿å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            if (content.length > 280) {
                alert('æŠ•ç¨¿ã¯280æ–‡å­—ä»¥å†…ã«ã—ã¦ãã ã•ã„');
                return;
            }

            try {
                const response = await fetch('/api/admin/x-posts', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${Auth.getToken()}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ content: content })
                });

                if (!response.ok) throw new Error('æŠ•ç¨¿ã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ');

                textarea.value = '';
                document.getElementById('custom-post-count').textContent = '0 / 280æ–‡å­—';
                alert('ã‚­ãƒ¥ãƒ¼ã«è¿½åŠ ã—ã¾ã—ãŸ');
                loadXPosts();
            } catch (error) {
                alert(error.message);
            }
        }

        function escapeForJs(text) {
            return text.replace(/\\/g, '\\\\').replace(/'/g, "\\'").replace(/\n/g, '\\n');
        }

        // =============================================================================
        // ãƒ–ãƒ­ã‚°è¨˜äº‹ç®¡ç†
        // =============================================================================

        async function loadAdminArticles() {
            const listEl = document.getElementById('article-list-admin');
            if (!listEl) return;

            try {
                const response = await Auth.authFetch('/api/admin/articles');
                if (!response.ok) throw new Error('è¨˜äº‹ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
                const data = await response.json();

                if (data.articles.length === 0) {
                    listEl.innerHTML = '<p class="section-desc">ã¾ã è¨˜äº‹ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
                    return;
                }

                listEl.innerHTML = data.articles.map(article => `
                    <div class="admin-article-item">
                        <div class="admin-article-info">
                            <span class="article-status-badge ${article.is_published ? 'published' : 'draft'}">${article.is_published ? 'å…¬é–‹' : 'ä¸‹æ›¸ã'}</span>
                            <strong>${escapeHtml(article.title)}</strong>
                            <span class="admin-article-slug">/blog/${escapeHtml(article.slug)}</span>
                            <span class="admin-article-date">${formatDate(article.published_at || article.created_at)}</span>
                        </div>
                        <div class="admin-article-actions">
                            ${article.is_published
                                ? `<a href="/blog/${escapeHtml(article.slug)}" target="_blank" class="admin-btn admin-btn-small admin-btn-secondary">è¡¨ç¤º</a>`
                                : ''
                            }
                            <button class="admin-btn admin-btn-small" onclick="handleEditArticle(${article.id})">ç·¨é›†</button>
                            <button class="admin-btn admin-btn-small ${article.is_published ? 'admin-btn-secondary' : 'admin-btn-success'}" onclick="toggleArticlePublished(${article.id}, ${article.is_published})">${article.is_published ? 'éå…¬é–‹' : 'å…¬é–‹'}</button>
                            <button class="admin-btn admin-btn-small admin-btn-danger" onclick="handleDeleteArticle(${article.id})">å‰Šé™¤</button>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                listEl.innerHTML = `<p class="error">${error.message}</p>`;
            }
        }

        function generateSlugFromTitle() {
            const title = document.getElementById('article-title').value;
            const slugEl = document.getElementById('article-slug');
            // ç·¨é›†ä¸­ã§ãªã‘ã‚Œã°è‡ªå‹•ç”Ÿæˆ
            if (document.getElementById('article-edit-id').value) return;
            // ãƒ­ãƒ¼ãƒå­—å¤‰æ›ã¯é›£ã—ã„ã®ã§ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ãƒ™ãƒ¼ã‚¹ã®slugã‚’ç”Ÿæˆ
            if (title.trim()) {
                const slug = title.trim()
                    .toLowerCase()
                    .replace(/[^\w\u3040-\u309f\u30a0-\u30ff\u4e00-\u9faf\s-]/g, '')
                    .replace(/[\sã€€]+/g, '-')
                    .replace(/-+/g, '-')
                    .replace(/^-|-$/g, '');
                slugEl.value = slug || `article-${Date.now()}`;
            }
        }

        let markdownViewVisible = false;
        let syncDebounceTimer = null;

        // turndownè¨­å®šï¼ˆHTMLâ†’Markdownå¤‰æ›ï¼‰
        const turndownService = new TurndownService({
            headingStyle: 'atx',
            codeBlockStyle: 'fenced',
            emDelimiter: '*',
        });

        // Markdownã‚½ãƒ¼ã‚¹è¡¨ç¤ºãƒˆã‚°ãƒ«
        function toggleMarkdownView() {
            markdownViewVisible = !markdownViewVisible;
            const textarea = document.getElementById('article-content');
            const btn = document.getElementById('toggle-markdown-btn');
            if (markdownViewVisible) {
                syncEditorToTextarea();
                textarea.classList.remove('hidden');
                btn.textContent = 'Markdownéè¡¨ç¤º';
            } else {
                textarea.classList.add('hidden');
                btn.textContent = 'Markdown';
            }
        }

        // WYSIWYGã‚¨ãƒ‡ã‚£ã‚¿ â†’ textareaï¼ˆå¸¸æ™‚åŒæœŸï¼‰
        function syncEditorToTextarea() {
            clearTimeout(syncDebounceTimer);
            syncDebounceTimer = setTimeout(() => {
                const html = document.getElementById('wysiwyg-editor').innerHTML;
                document.getElementById('article-content').value = turndownService.turndown(html);
            }, 300);
        }

        // textarea â†’ WYSIWYGã‚¨ãƒ‡ã‚£ã‚¿ï¼ˆMarkdownæ‰‹å‹•ç·¨é›†æ™‚ï¼‰
        function syncTextareaToEditor() {
            const content = document.getElementById('article-content').value;
            document.getElementById('wysiwyg-editor').innerHTML =
                DOMPurify.sanitize(marked.parse(content || ''));
        }

        // ã‚¨ãƒ‡ã‚£ã‚¿ã«Markdownã‚’ãƒ­ãƒ¼ãƒ‰ï¼ˆç·¨é›†é–‹å§‹ãƒ»åˆæœŸåŒ–æ™‚ï¼‰
        function loadContentToEditor(markdown) {
            document.getElementById('article-content').value = markdown;
            document.getElementById('wysiwyg-editor').innerHTML =
                DOMPurify.sanitize(marked.parse(markdown || ''));
        }

        // ã‚¨ãƒ‡ã‚£ã‚¿ã«ç”»åƒãƒ‰ãƒ­ãƒƒãƒ—
        async function handleEditorImageDrop(event) {
            event.preventDefault();
            const files = event.dataTransfer.files;
            for (const file of files) {
                if (!file.type.startsWith('image/')) continue;
                try {
                    const url = await uploadImage(file);
                    const img = document.createElement('img');
                    img.src = url;
                    img.style.maxWidth = '100%';
                    const sel = window.getSelection();
                    if (sel.rangeCount) {
                        const range = sel.getRangeAt(0);
                        range.deleteContents();
                        range.insertNode(img);
                        range.collapse(false);
                    } else {
                        document.getElementById('wysiwyg-editor').appendChild(img);
                    }
                    syncEditorToTextarea();
                } catch (error) {
                    alert(error.message);
                }
            }
        }

        async function handleSubmitArticle() {
            // ä¿å­˜å‰ã«ã‚¨ãƒ‡ã‚£ã‚¿â†’textareaã‚’ç¢ºå®Ÿã«åŒæœŸ
            const html = document.getElementById('wysiwyg-editor').innerHTML;
            document.getElementById('article-content').value = turndownService.turndown(html);

            const editId = document.getElementById('article-edit-id').value;
            const payload = {
                title: document.getElementById('article-title').value.trim(),
                slug: document.getElementById('article-slug').value.trim(),
                description: document.getElementById('article-description').value.trim(),
                content: document.getElementById('article-content').value.trim(),
                thumbnail_url: document.getElementById('article-thumbnail').value.trim(),
                is_published: document.getElementById('article-published').checked,
            };

            if (!payload.title || !payload.slug || !payload.content) {
                alert('ã‚¿ã‚¤ãƒˆãƒ«ã€ã‚¹ãƒ©ãƒƒã‚°ã€æœ¬æ–‡ã¯å¿…é ˆã§ã™');
                return;
            }

            try {
                const url = editId ? `/api/admin/articles/${editId}` : '/api/admin/articles';
                const method = editId ? 'PUT' : 'POST';
                const response = await Auth.authFetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                });

                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.detail || 'ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }

                clearLocalDraft();
                alert(editId ? 'è¨˜äº‹ã‚’æ›´æ–°ã—ã¾ã—ãŸ' : 'è¨˜äº‹ã‚’ä½œæˆã—ã¾ã—ãŸ');
                clearArticleForm();
                loadAdminArticles();
            } catch (error) {
                alert(error.message);
            }
        }

        async function handleEditArticle(id) {
            try {
                const response = await Auth.authFetch(`/api/admin/articles/${id}`);
                if (!response.ok) throw new Error('è¨˜äº‹ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
                const data = await response.json();
                const article = data.article;

                document.getElementById('article-edit-id').value = article.id;
                document.getElementById('article-title').value = article.title;
                document.getElementById('article-slug').value = article.slug;
                document.getElementById('article-description').value = article.description;
                loadContentToEditor(article.content);
                document.getElementById('article-thumbnail').value = article.thumbnail_url || '';
                document.getElementById('article-published').checked = !!article.is_published;

                document.getElementById('article-form-title').textContent = 'è¨˜äº‹ã‚’ç·¨é›†';
                document.getElementById('article-submit-btn').textContent = 'æ›´æ–°';
                document.getElementById('article-cancel-btn').style.display = '';

                // è¨˜äº‹ã‚¿ãƒ–ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
                document.getElementById('tab-articles').scrollIntoView({ behavior: 'smooth' });
            } catch (error) {
                alert(error.message);
            }
        }

        function cancelEditArticle() {
            clearArticleForm();
        }

        function clearArticleForm() {
            document.getElementById('article-edit-id').value = '';
            document.getElementById('article-title').value = '';
            document.getElementById('article-slug').value = '';
            document.getElementById('article-description').value = '';
            document.getElementById('article-content').value = '';
            document.getElementById('article-thumbnail').value = '';
            document.getElementById('article-published').checked = false;
            document.getElementById('article-form-title').textContent = 'æ–°ã—ã„è¨˜äº‹ã‚’ä½œæˆ';
            document.getElementById('article-submit-btn').textContent = 'ä½œæˆ';
            document.getElementById('article-cancel-btn').style.display = 'none';
            document.getElementById('wysiwyg-editor').innerHTML = '';
            document.getElementById('article-content').classList.add('hidden');
            document.getElementById('toggle-markdown-btn').textContent = 'Markdown';
            markdownViewVisible = false;
            clearLocalDraft();
        }

        // === é€²æ—ä¿å­˜ï¼ˆlocalStorageè‡ªå‹•ä¿å­˜ + ä¸‹æ›¸ãã‚µãƒ¼ãƒãƒ¼ä¿å­˜ï¼‰===
        const DRAFT_STORAGE_KEY = 'bsprice_article_draft';
        let autosaveTimer = null;

        function getFormData() {
            const html = document.getElementById('wysiwyg-editor').innerHTML;
            return {
                editId: document.getElementById('article-edit-id').value,
                title: document.getElementById('article-title').value,
                slug: document.getElementById('article-slug').value,
                description: document.getElementById('article-description').value,
                content: turndownService.turndown(html),
                thumbnail_url: document.getElementById('article-thumbnail').value,
                savedAt: new Date().toISOString(),
            };
        }

        function autoSaveToLocal() {
            const data = getFormData();
            // ä½•ã‚‚å…¥åŠ›ã•ã‚Œã¦ã„ãªã‘ã‚Œã°ä¿å­˜ã—ãªã„
            if (!data.title && !data.content) return;
            localStorage.setItem(DRAFT_STORAGE_KEY, JSON.stringify(data));
            showAutosaveStatus('è‡ªå‹•ä¿å­˜æ¸ˆã¿');
        }

        function scheduleAutosave() {
            clearTimeout(autosaveTimer);
            autosaveTimer = setTimeout(autoSaveToLocal, 5000);
        }

        function showAutosaveStatus(msg) {
            const el = document.getElementById('autosave-status');
            el.textContent = msg;
            el.classList.add('visible');
            setTimeout(() => el.classList.remove('visible'), 3000);
        }

        function clearLocalDraft() {
            localStorage.removeItem(DRAFT_STORAGE_KEY);
        }

        function restoreLocalDraft() {
            const saved = localStorage.getItem(DRAFT_STORAGE_KEY);
            if (!saved) return;
            try {
                const data = JSON.parse(saved);
                const ago = Math.round((Date.now() - new Date(data.savedAt).getTime()) / 60000);
                const timeLabel = ago < 1 ? '1åˆ†ä»¥å†…' : `${ago}åˆ†å‰`;
                if (!confirm(`ä¿å­˜ã•ã‚Œã¦ã„ãªã„ä¸‹æ›¸ããŒã‚ã‚Šã¾ã™ï¼ˆ${timeLabel}ï¼‰ã€‚å¾©å…ƒã—ã¾ã™ã‹ï¼Ÿ`)) {
                    clearLocalDraft();
                    return;
                }
                if (data.editId) document.getElementById('article-edit-id').value = data.editId;
                document.getElementById('article-title').value = data.title || '';
                document.getElementById('article-slug').value = data.slug || '';
                document.getElementById('article-description').value = data.description || '';
                loadContentToEditor(data.content || '');
                document.getElementById('article-thumbnail').value = data.thumbnail_url || '';
                if (data.editId) {
                    document.getElementById('article-form-title').textContent = 'è¨˜äº‹ã‚’ç·¨é›†';
                    document.getElementById('article-submit-btn').textContent = 'æ›´æ–°';
                    document.getElementById('article-cancel-btn').style.display = '';
                }
                showAutosaveStatus('ä¸‹æ›¸ãã‚’å¾©å…ƒã—ã¾ã—ãŸ');
            } catch (e) {
                clearLocalDraft();
            }
        }

        // ä¸‹æ›¸ãã¨ã—ã¦ã‚µãƒ¼ãƒãƒ¼ã«ä¿å­˜ï¼ˆéå…¬é–‹ã§ä¿å­˜ï¼‰
        async function handleSaveDraft() {
            const html = document.getElementById('wysiwyg-editor').innerHTML;
            document.getElementById('article-content').value = turndownService.turndown(html);

            const editId = document.getElementById('article-edit-id').value;
            const payload = {
                title: document.getElementById('article-title').value.trim() || 'ç„¡é¡Œã®ä¸‹æ›¸ã',
                slug: document.getElementById('article-slug').value.trim() || `draft-${Date.now()}`,
                description: document.getElementById('article-description').value.trim(),
                content: document.getElementById('article-content').value.trim(),
                thumbnail_url: document.getElementById('article-thumbnail').value.trim(),
                is_published: false,
            };

            if (!payload.content) {
                alert('æœ¬æ–‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            try {
                const url = editId ? `/api/admin/articles/${editId}` : '/api/admin/articles';
                const method = editId ? 'PUT' : 'POST';
                const response = await Auth.authFetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                });

                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.detail || 'ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }

                const result = await response.json();
                // æ–°è¦ä½œæˆã®å ´åˆã€ä»¥é™ã¯ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆ
                if (!editId && result.article) {
                    document.getElementById('article-edit-id').value = result.article.id;
                    document.getElementById('article-form-title').textContent = 'è¨˜äº‹ã‚’ç·¨é›†';
                    document.getElementById('article-submit-btn').textContent = 'æ›´æ–°';
                    document.getElementById('article-cancel-btn').style.display = '';
                }

                clearLocalDraft();
                showAutosaveStatus('ä¸‹æ›¸ãã‚’ä¿å­˜ã—ã¾ã—ãŸ');
                loadAdminArticles();
            } catch (error) {
                alert(error.message);
            }
        }

        // WYSIWYGã‚¨ãƒ‡ã‚£ã‚¿ã®å…¥åŠ›æ™‚ã«è‡ªå‹•ä¿å­˜ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«
        const _origSyncEditor = syncEditorToTextarea;
        syncEditorToTextarea = function() {
            _origSyncEditor();
            scheduleAutosave();
        };

        // === ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰é–¢é€£ ===
        async function uploadImage(file) {
            const formData = new FormData();
            formData.append('file', file);
            const response = await Auth.authFetch('/api/admin/upload-image', {
                method: 'POST',
                body: formData,
            });
            if (!response.ok) {
                const err = await response.json();
                throw new Error(err.detail || 'ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
            const data = await response.json();
            return data.url;
        }

        function insertImageToEditor(url) {
            const editor = document.getElementById('wysiwyg-editor');
            const img = document.createElement('img');
            img.src = url;
            img.style.maxWidth = '100%';
            const sel = window.getSelection();
            if (sel.rangeCount && editor.contains(sel.anchorNode)) {
                const range = sel.getRangeAt(0);
                range.deleteContents();
                range.insertNode(img);
                range.collapse(false);
            } else {
                editor.appendChild(img);
            }
            syncEditorToTextarea();
        }

        async function handleContentImageSelect(file) {
            if (!file) return;
            try {
                const url = await uploadImage(file);
                insertImageToEditor(url);
            } catch (error) {
                alert(error.message);
            }
            document.getElementById('content-image-input').value = '';
        }

        async function uploadThumbnailImage(file) {
            if (!file) return;
            try {
                const url = await uploadImage(file);
                document.getElementById('article-thumbnail').value = url;
            } catch (error) {
                alert(error.message);
            }
            document.getElementById('thumbnail-file-input').value = '';
        }

        async function toggleArticlePublished(id, currentState) {
            const action = currentState ? 'éå…¬é–‹ã«ã—ã¾ã™ã‹ï¼Ÿ' : 'å…¬é–‹ã—ã¾ã™ã‹ï¼Ÿ';
            if (!confirm(action)) return;

            try {
                const response = await Auth.authFetch(`/api/admin/articles/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ is_published: !currentState }),
                });
                if (!response.ok) throw new Error('æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ');
                loadAdminArticles();
            } catch (error) {
                alert(error.message);
            }
        }

        async function handleDeleteArticle(id) {
            if (!confirm('ã“ã®è¨˜äº‹ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;

            try {
                const response = await Auth.authFetch(`/api/admin/articles/${id}`, {
                    method: 'DELETE',
                });
                if (!response.ok) throw new Error('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
                loadAdminArticles();
            } catch (error) {
                alert(error.message);
            }
        }

        // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatDate(dateStr) {
            if (!dateStr) return '';
            // UTCã¨ã—ã¦è§£é‡ˆã™ã‚‹ãŸã‚ã«Zã‚’è¿½åŠ ï¼ˆæ—¢ã«ã‚ã‚‹å ´åˆã¯è¿½åŠ ã—ãªã„ï¼‰
            let utcStr = dateStr;
            if (!dateStr.endsWith('Z') && !dateStr.includes('+')) {
                utcStr = dateStr.replace(' ', 'T') + 'Z';
            }
            const date = new Date(utcStr);
            return date.toLocaleString('ja-JP', {
                timeZone: 'Asia/Tokyo',
                year: 'numeric',
                month: 'numeric',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
    </script>
</body>
</html>
